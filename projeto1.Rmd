---
title: "Projeto I"
author:
- Bárbara Oliveira Ribeiro
- Nathalia Gabriella Ferreira dos Santos
date: "`r Sys.Date()`"
output:
  pdf_document:
    number_sections: yes
    fig_caption: yes
#header-includes: \usepackage[brazil]{babel}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, # true mostra o codigo
	message = FALSE,
	warning = FALSE
)
#options(OutDec = ",")
```

```{r pacotes, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(patchwork) # para parcionar os graficos
library(kableExtra)
library(janitor)
```

```{r limpa_env}
rm(list = ls())
```


```{r}
# Função Resumo testes de hipoteses
resumo_testes <- function(teste, variavel){
    pvalor <- teste$p.value
    metodo <- teste$method  
    alpha <- 0.05
    conclusao <- if_else(pvalor >= alpha, "Não rejeita-se H0", "Rejeita-se H0")
    
    lista <- list(
      Nome = variavel,
      `Método` = metodo,
      Pvalor = pvalor %>% round(4),
      `Conclusão` = conclusao)
    
    return(lista %>% as_tibble() )
}
```


# Introdução

# Objetivo

# Metodologia

# Resultados

## Tamanho Amostral

Para o cálculo do tamanho da amostra onde o objetivo do estudo era comparar dois grupos: grupo tratamento com um controle, no contexto do trabalho o grupo controle seriam as mulheres que tiveram gestações saudáveis *(MN)* e o grupo tratamento seriam mulheres que tiveram pré-eclâmpsia *(MP)*. As variâncias para os grupos serão denotados por $\sigma^2_{MN}$ e $\sigma^2_{MP}$, respectivamente, e foram obtidas por meio de estudo piloto e repassado pela cliente para o estudo.

As variâncias para a **pressão sistólica** são:

* Grupo MN: 196,90

* Grupo MP: 514,95

Então, escolhendo um nível de significância de $\alpha = 0,05$ e um poder de teste de $\beta = 0,10$, tem-se que:

```{r calc_amostral}
var1 <- 196.9
var2 <- 514.95
alpha <- 0.05
beta <- 0.1
delta <- c(0.1, 0.5, 1, 2, 5, 10) # erro

z2 <- qnorm(1 - alpha/2)
zbeta <- qnorm(1 - beta)

#se o erro aumenta, o n diminui. peq erros maior n
n = ((var1 + var2) * (z2 + zbeta)^2) / (delta^2) 

tibble(
  "Erro" = delta,
  "Tamanho Amostral" = n %>% round()
) %>% 
  kable(
    caption = "Cálculo do tamanho amostral para diferentes erros",
    format.args = list(big.mark = "."))
```

O *erro* aqui é chamado a diferença das médias do grupo MN e MP. Nota-se que quanto menor o erro, ou seja, quão próximo deseja-se que as médias dos grupos sejam "iguais", maior será a amostra a ser avaliada para garantir boa estimação. 

## Curva de concentração do Sflt1

Devido ao não registro de valores de *concentração* de Sflt1 (provavelmente devido a baixa acurácia do equipamento na medição para valores pequenos de concentração), e tendo o resultado da *absorbância* observada, foi solicitado a estimação teórica dessas concentrações.


É conhecido por meio da literatura que essa concentração a ser estimada segue uma equação conhecida como **Four parameter logistic regression** (Modelo de Regressão Logística de 4 Parâmetros) a qual é muito usada para dados de ensaio imunoabsorvente enzimático - ELISA (Enzyme-linked immunosorbent assay). Cabe então, a estimação dos parâmetros da curva por meio da regressão específica do problema.


Esse modelo de regressão possui como variável resposta a **absorbância** e como variável explicativa a **concentração**. Entretanto, o objetivo final da estimação é predizer valores de concentração para uma absorbância conhecida. Assim, a princípio usou-se os dados teóricos disponibilizados para estimar os parâmetros. Foi buscado na literatura ajustes semelhantes e optou-se pela implementação *LL2.4* contida no pacote *drc* do R-Studio. A função *LL2.4* fornece a parametrização da função por meio da log-logística de quatro parâmetros, uma função de auto-inicialização (caso o algoritmo seja iterativo e parta de um "chute inicial"), e os nomes dos parâmetros. Como está sendo usada a transformação $log_{2}$ para estimar os parâmetros, para conversão final da concentração estimada será aplicada a inversa da transformação para achar o valor real da concentração.

* **c** indica a inclinação da curva (Slope)


* **c** indica o limite inferior (Amin)


* **d** indica o limite superior (Amax)


* **e** indica o ponto de inflexão (ED50 que nessa parametrização é log2ED50)


O resultado encontrado foi:


```{r dados_curva}
resultado <- read_xlsx("curva.xlsx", sheet = "prev") # valores a serem preditos
resultado_luiza <- read_xlsx("curva.xlsx", sheet = "ajust") %>% 
  rename("Ajuste Luiza" = ajust)
```

```{r ajuste_curva}
library(drc)

data <- read_xlsx("dados_teoricos.xlsx")

new <- data.frame(
  conc = seq(0,50, 0.01)
)

# ajusta pelo metodo o LL2, no anterior era o LL. Esse eh o log2. dif minima entre ambos
drc.fit <- drm(abs ~ conc,
  data = data,
  fct = LL2.4( 
    names = c("Slope", "Amin", "Amax", "log2ED50")
    )
)

# Extraindo coefs
coefs.data <- setNames(
  drc.fit$coefficients %>% round(4),
  c("b", "c", "d", "e")
)
cbind(coefs.data) %>% kable(caption = "Valores estimados dos parâmetros")

#summary(drc.fit)
```

Para testar a significância dos parâmetros, um intervalo de confiança foi obtido. Exceto o parâmetro de máximo e mínimo, conclui-se que todos demais são significativos.

```{r ic_ajuste}
confint(drc.fit) %>% round(3) %>% kable(caption = "Intervalo de confiança para os parâmetros")
```

Por meio do gráfico é possível notar o quão bem a curva se ajustou aos dados teóricos.

```{r fig.cap="Gráfico da estimação da curva para os dados teóricos",out.width = "70%", fig.align='center'}
plot(drc.fit, broken=F, xlab="Concentração", ylab="Absorbância", lwd=1.2, 
     cex=1.2, cex.axis=1.2, cex.lab=1.2)
```


### Análise de resíduos

A fim de validar alguns pressupostos da regressão e a partir do gráfico dos resíduos, nota-se que a homocedasticidade dos resíduos é válida.

```{r fig.cap="Gráfico dos valores ajustados pelos resíduos do modelo",out.width = "70%", fig.align='center'}
ggplot(as_tibble(drc.fit$predres)) +
  geom_point(aes(`Predicted values`, Residuals),
     size = 3, color = "cornflowerblue") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  labs(title = "Gráfico dos valores ajustados pelos resíduos")
```

De mesmo modo, sobre a hipótese nula de que os resíduos possuem distribuição normal, para o mesmo $\alpha = 0,05$, dado o $p-valor$ observado, não rejeita-se a hipótese nula.

```{r analise_residuos}
residuos <- drc.fit$predres[,2] 
teste <- residuos %>% shapiro.test()
resumo_testes(teste, "Resíduos") %>% 
  kable(caption = "Resumo teste de normalidade dos resíduos")
```

Logo conclui-se que a estimação parece se adequar bem aos dados e pode-se seguir para a estimação da concentração por meio desses parâmetros.

```{r eval=FALSE, include=FALSE}
abs_predita <- predict(object = drc.fit, new)
new$abs_inter <- abs_predita # prevista
#new %>% head() # ver se precisamos elevar os dados ao quadrado

novo_data <- new %>% dplyr::select(conc, abs_inter) %>% rename(abs = abs_inter)
novo_df <- rbind(data, novo_data)
#plot(log2(novo_df$conc), novo_df$abs)
plot(log2(new$conc), new$abs, type = "line")
```

### Estimação da concentração por imputação do limite inferior


Para estimação da concentração, como foi feita uma parametrização, a *Log2-concentração* será obstida e então convertida para escala padrão. Buscando-se na literatura referências, foi encontrado que além dos valores estimados, como deseja-se estimar concentrações abaixo do limite inferior, um novo candidato a mínimo deveria ser estipulado. Nesse caso, optou-se pelo mínimo ser o menor valor de concentração observado na amostra (`r min(resultado$abs)`). Esse valor está contido no Intervalo de Confiança para o mínimo. Os demais coeficientes serão os mesmos estimados.


As concentrações encontradas podem ser vistas na tabela que segue:


```{r}
prev.conc = resultado$abs

slope.est <- coef(drc.fit)[1]
Amax.est <- coef(drc.fit)[3]
log2EC50.est <- coef(drc.fit)[4]
# Set Amin to blank values
Amin <- min(resultado$abs) # media dos valores a serem previsto # zero também poderia ser

log2concentration.est <- sapply(
  prev.conc, function(A){(1/slope.est) * (log( ((Amax.est - A)/(A - Amin))) + log2EC50.est*slope.est)}
  )

results <- resultado %>% 
  dplyr::mutate(concentration.est = 2^log2concentration.est %>% round(3))

# resultados ja na escala desejada
left_join(results, resultado_luiza) %>% 
  arrange(abs) %>% 
  rename("Absorbância" = abs, "Concentração Estimada" = concentration.est) %>% 
  kable(
    caption = "Comparativo das estimações para concentração de Sflt1 abaixo da curva"
    )
```

Por fim, nota-se que os valores preditos parecem estar próximos do esperado para o comportamento dos dados teóricos.

```{r fig.cap="Concentração preditas com dados teóricos",out.width = "70%", fig.align='center'}
novo_results <- results %>% rename(conc = concentration.est)

novo_df <- rbind(data, novo_results)
novo_df <- novo_df %>% mutate(log2conc = log2(conc))

novo_df %>% 
  ggplot(aes(x = log2conc, y = abs)) +
  geom_smooth(method = "lm", formula = y ~ exp(x), se = FALSE, color = "red") + 
  geom_point() +
  labs(x = "Concentração", y = "Absorbância", title = "Gráfico")

#plot(novo_df$log2conc, novo_df$abs)
#plot(novo_df$log2conc, novo_df$abs, type = "line")

#novo_df <- rbind(data, novo_results, novo_data)
#plot(log2(novo_df$conc), novo_df$abs)
#plot(log2(new$conc), new$abs, type = "line")
```

```{r}
# tirando pacotes que podem dar conflito com o dplyr
detach("package:drc", unload = TRUE)
detach("package:MASS", unload = TRUE)
```

## Análises descritivas por grupo


A seguir, será apresentada algumas medidas de resumo para as variáveis de interesse contidas no banco de dados. Essas descritivas foram levantadas para avaliar principalmente o comportamento da variável em cada grupo, *Grupo MN* e *Grupo MP*.


Em síntese, as medidas descritivas escolhidas para os dados contínuos refletem:


* Boxplot: comparativo do comportamento dos dados para cada grupo e se há informações discrepantes;


* Tabela: medidas de resumos de tendência central e variabilidade, indicativo de nulos e número de observações encontradas e


* Histograma: a frequência geral da variável de interesse.


Caso fossem encontrados dados extremos, visando melhores estimativas, eles foram retirados das medidas de resumo.


Para os dados categóricos, a medida descritiva escolhida foi um gráfico de barras para avaliar a proporção de cada grupo (*MN* e *MP*) dentro de cada categoria. Dentre algumas variáveis categóricas, foi gerado uma tabela de frequência para avaliar a proporção da categoria dentro de cada grupo (*MN* e *MP*).


```{r importa_dados}
df1 <- read_xlsx("dados.xlsx", sheet = "Dados Atuais")
df2 <- read_xlsx("dados.xlsx", sheet = "Dados Gestacionais")
df3 <- read_xlsx("dados.xlsx", sheet = "ELISAs")
df4 <- read_xlsx("dados.xlsx", sheet = "Imunoturbidimetria")
df5 <- read_xlsx("dados.xlsx", sheet = "Doenças Crônicas")
```


```{r funcoes_trata_dados}
##Funções para tratar os dados:

coluna_na_numerica <- function(lista, caracter = ".", substituto = ""){
  lista %>% 
    str_replace(. , pattern = ",", replacement = ".") %>%
    str_replace_na(. , replacement = "") %>% 
    ifelse(. == caracter, substituto, .) %>% as.numeric()
}

coluna_numerica <- function(lista){
  lista %>% 
    ifelse(. == 99999, NA, .) %>% as.numeric()
}
```


```{r tratamento_df1}
#### DF1: Dados Atuais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "ETNIA                1:branca   2:parda   3:negra",
  "IDADE    anos",
  "ESCOLARIDADE COMPLETA  0: 4ª série completa   1:fundamental completo 2:médio completo 3:ensino técnico completo 4:superior completo 5:pós-graduação completa",
  "NÚMERO GESTAÇÕES",
  "Peso (kg)",
  "IMC",
  "GORDURA (%)",
  "PRESSÃO SISTÓLICA (mmHg)",
  "PRESSÃO DIASTÓLICA (mmHg)",
  "PRESSÃO ARTERIAL MÉDIA",
  "CINTURA (cm)",
  "ABDÔMEN (cm)",
  "QUADRIL (cm)",
  "RELAÇÃO CINTURA/QUADRIL",
  "NEU (10³/µL)",
  "LYM (10³/µL)",
  "NLR",
  "Colesterol total (mg/dL)",
  "HDL (mg/dL)",
  "LDL (mg/dL) DOSADO",
  "VLDL (mg/dL)",
  "Não-HDL (mg/dL)",
  "Triglicérides (mg/dL)",
  "HbA1c (%)",
  "Creatinina (mg/dL)",
  "Ritmo de filtrção glomerular calculado",
  "TGP/ALT",
  "TGO/AST",
  "Ácido Úrico",
  "CK",
  "Gama GT",
  "USA ANTI-HIPERTENSIVO 0:não 1:sim",
  "USA MEDICAMENTO PARA DIABETES 0:não 1:sim",
  "USA MEDICAMENTO PARA HIPERCOLESTEROLEMIA 0:não 1:sim",
  "TABAGISTA 0: não   1:sim" 
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "etnia",
  "idade",
  "escolaridade",
  "num_gestacoes",
  "peso",
  "imc",
  "gordura",  
  "pressao_sis",
  "pressao_dias",
  "pressao_media", 
  "cintura",
  "abdomen",
  "quadril",
  "cintura_quadril",
  "neu",
  "lym",
  "nlr",
  "colesterol_total",
  "hdl",
  "ldl_dosado",
  "vldl",
  "nao_hdl",
  "triglicerides",
  "hba1c",
  "creatinina",
  "filtr_glomerular",
  "tgp_alt",
  "tgo_ast",
  "acido_urico",
  "ck",
  "gama_gt",
  "anti_hiper",
  "medic_diabetes",
  "medic_hipercol",
  "tabagista"
  )


df1 <- df1 %>% dplyr::select(all_of(colunas_interesse))
colnames(df1) <- renomear_colunas

grupos_nulos <- df1 %>% select(grupo) %>% is.na()
df1 <- df1 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    etnia = coluna_numerica(etnia),
    escolaridade = as.factor(escolaridade),
    peso = coluna_numerica(peso),
    imc = coluna_na_numerica(imc, "#DIV/0!", NA) %>% coluna_numerica(),
    gordura = coluna_na_numerica(gordura) %>% coluna_numerica(),
    pressao_sis = coluna_numerica(pressao_sis),
    pressao_dias = coluna_numerica(pressao_dias),
    pressao_media = coluna_numerica(pressao_media),
    cintura = coluna_numerica(cintura),
    abdomen = coluna_numerica(abdomen),
    quadril = coluna_numerica(quadril),
    cintura_quadril = coluna_na_numerica(cintura_quadril, "#DIV/0!", NA) %>% coluna_numerica(),
    nlr = coluna_na_numerica(nlr, "#DIV/0!", NA) %>% coluna_numerica(),
    ldl_dosado = coluna_na_numerica(ldl_dosado, "#DIV/0!", NA) %>% coluna_numerica(),
    vldl = coluna_na_numerica(vldl, "#DIV/0!", NA) %>% coluna_numerica(),
    hba1c = coluna_numerica(hba1c),
    creatinina = coluna_numerica(creatinina),
    filtr_glomerular = coluna_na_numerica(filtr_glomerular, "#DIV/0!", NA) %>% coluna_numerica(),
    ck = coluna_numerica(ck)
    )

df1 <- df1 %>%
  mutate_at(vars(-c(iniciais, grupo, escolaridade, etnia, num_gestacoes)), as.numeric)
```


```{r tratamento_df2}
####  DF2: Dados Gestacionais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "Há quantos anos",
  "PESO BEBÊ (kg)",
  "PARTO                                     0:normal   1:cesariana   2:fórceps  3: induzido",
  "PARTO PREMATURO 0:não      1:sim"
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "quantos_anos_evento",
  "peso_bebe",
  "tipo_parto",
  "prematuro"
  )

df2 <- df2 %>% select(all_of(colunas_interesse))
colnames(df2) <- renomear_colunas

grupos_nulos <- df2 %>% select(grupo) %>% is.na()
df2 <- df2 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    quantos_anos_evento = quantos_anos_evento %>% as.numeric(),
    peso_bebe = coluna_numerica(peso_bebe),
    tipo_parto = as.factor(coluna_numerica(tipo_parto)),
    prematuro = as.factor(prematuro)
    )
```


```{r tratamento_df3}
#### DF3: ELISAs

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "PAI-1 (ng/mL)",
 "Log PAI-1 (ng/mL)",
 "TROMBOMODULINA (ng/mL)",
 "ADMA (ng/mL)",
 "sFlt1 (pg/mL)",
 "Absorbâncias sFlt1",
 "sFlt1 (pg/mL) Ajuste linear (Luiza)",
 "AA-AT1 (ng/mL)"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "pai1",
 "logpai1",
 "trombomodulina",
 "adma",
 "sflt1",
 "absor_sflt1",
 "sflt1_ajuste",  
 "aaat1"
)
df3 <- df3 %>% select(all_of(colunas_interesse))
colnames(df3) <- renomear_colunas

df3 <- df3 %>% drop_na(grupo) %>% 
  mutate(
  pai1 = coluna_numerica(pai1),
  logpai1 = coluna_numerica(logpai1),
  trombomodulina = coluna_numerica(trombomodulina),
  adma = coluna_numerica(adma), 
  sflt1 = coluna_na_numerica(sflt1, "< curva", NA) %>% coluna_numerica(),
  absor_sflt1 = coluna_numerica(absor_sflt1),
  sflt1_ajuste = coluna_numerica(sflt1_ajuste),
  aaat1 = coluna_numerica(aaat1)
)

df3 <- df3 %>%
  mutate_at(vars(-iniciais), as.numeric)

# corrigindo outro erro de adma
df3$adma <- df3$adma %>% ifelse(. == 999999, NA, .) %>% as.numeric()
```


```{r tratamento_df4}
#### DF4: Imunoturbidimetria

colunas_interesse <- c(
   "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "DÍMERO-D (ng/mL)",
 "LOG DÍMERO-D"
)
renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "dimero",
 "logdimero"
)
df4 <- df4 %>% select(all_of(colunas_interesse))
colnames(df4) <- renomear_colunas

df4 <- df4 %>% 
  mutate_at(vars(-iniciais), as.numeric)

# alterando df4
df4 <- df4 %>% mutate(
    dimero = coluna_numerica(dimero)
)
```


```{r tratamento_df5}
#### DF5: Doenças Crônicas

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "HIPERTENSÃO 0:não   1:sim",
 "DIABETES 0:não   1:sim",
 "HIPERCOLESTEROLEMIA 0:não   1:sim",
 "FIBROMIALGIA 0:não   1:sim",
 "GLAUCOMA 0:não   1:sim",
 "ENXAQUECA 0:não   1:sim",
 "HIPOTIREOIDISMO 0:não   1:sim",
 "ASMA 0:não   1:sim",
 "ESTEATOSE HEPÁTICA 0:não   1:sim",
 "SÍNDROME DO INTESTINO IRRITÁVEL 0:não   1:sim",
 "HEMANGIOMA  0:não   1:sim",
 "TROMBOFILIA  0:não   1:sim",
 "BRONQUITE  0:não   1:sim",
 "RINITE  0:não   1:sim",
 "OVÁRIOS POLICÍSTICOS 0:não   1:sim",
  "Transtorno de ansiedade generalizada (TAG)  0:não   1:sim",
 "SINUSITE 0:não 1:sim",
 "DEPRESSÃO 0:não   1:sim",
 "ARTROSE 0:não   1:sim",
 "LEUCOCITOSE 0:não   1:sim",
 "ANEMIA 0:não   1:sim",
 "SÍNDROME DO PÂNICO 0:não   1:sim",
 "GASTRITE 0:não   1:sim",
 "HEPATITE 0:não   1:sim",
 "CRISE ALÉRGICA 0:não   1:sim",
 "CISTITE 0:não   1:sim",
 "ANEMIA FALCIFORME 0: não 1:sim",
 "MIOMA UTERINO 0: não 1: sim",
 "CÁLCULO RENAL 0: não 1: sim",
 "CALCIFICAÇÃO MAMÁRIA 0: não 1: sim",
 "HIPOGLICEMIA 0: não 1: sim",
 "DERRAME DE VISTA 0: não 1: sim",
 "HIDRADENITE 0: não 1: sim",
 "GLOMERULOESCLEREOSE  0: não 1: sim",
 "PRÉ-DIABETES 0: não 1: sim",
  "BIPOLAR 0: não 1: sim",
  "TDAH 0: não 1: sim",
  "TEA 0: não 1: sim",
  "DOENÇA DE STILL 0: não 1: sim"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "hipertensao",
 "diabetes",
 "hipercolesterolemia",
 "fibromialgia",
 "glaucoma",
 "enxaqueca",
 "hipotireoidismo",
 "asma",
 "esteatose_hepatica",
 "sindrome_intestino_irritavel",
 "hemangioma",
 "trombofilia",
 "bronquite",
 "rinite",
 "ovario_policistico",
 "TAG",
 "sinusite",
 "depressao",
 "artrose",
 "leucocitose",
 "anemia",
 "sindrome_panico",
 "gastrite",
 "hepatite",
 "crise_alergica",
 "cistite",
 "anemia_falciforme",
 "mioma_uterino",
 "calculo_renal",
 "calcificacao_mamaria",
 "hipoglicemia",
 "derrame de vista",
 "hidradenite",
 "glomeruloesclerose",
 "pre_diabetes",
 "bipolaridade",
 "TDAH",
 "TEA",
 "Doenca_Still"
)

df5 <- df5 %>% select(all_of(colunas_interesse))
colnames(df5) <- renomear_colunas

df5 <- df5 %>% 
  mutate_at(vars(-iniciais), as.numeric)
```

```{r tema_graficos}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```


```{r funcoes_aplicadas_descritivas}
# Funcoes de gráficos numericos e categoricos
graficos <- function(dados, grupo, variavel, texto = "variável"){
  
  dados <- dados %>% 
    mutate(grupo = ifelse(grupo == "0", "Grupo MN", "Grupo MP"))
  
  tab <- dados %>% 
    group_by(grupo) %>% 
    summarise(
      `Média` = mean( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Des. Padrão`= sd( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Nulos` = is.na( !!sym(variavel) ) %>% sum() %>% round(2),
      `Quant.` = n() %>% round()) %>% 
    t()
  
  tabela <- data.frame(
    "Métrica" = row.names(tab)[2:5], 
    "MN" = as.numeric(tab[c(-1),1]),
    "MP" = as.numeric(tab[c(-1),2])) %>% 
    as_tibble()
  
  dados <- dados %>% filter(! is.na(variavel) )
  
  g1 <- dados %>%
    ggplot(aes(x = !!sym(grupo), y = !!sym(variavel), fill = !!sym(grupo))) + 
    geom_boxplot() + 
    labs(title = "Descritivas\n", x = "Grupos", y = str_to_upper(variavel), fill = "Grupos") +
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa))

  g2 <- dados %>% 
    ggplot(aes(x = !!sym(variavel))) +
    geom_histogram(fill = cor_verde) + 
    labs(y = "Frequência", x = str_to_upper(variavel))
  
  return(
    (g1 + gridExtra::tableGrob(tabela, rows = c("", "","", "")))/ 
      (g2)
  )
  }

# Funcao para gráficos categóricos
graficos_categoricos <- function(lista1, lista2, variavel){
  
  tabela <- prop.table(
    table(lista1, lista2), 
    margin = 2) #freq da escolaridade dentro dos grupos, ex: freq do grupo 2 no grupo 1
  
  perc <- data.frame(tabela) %>% 
    mutate(lista1 = ifelse(lista1 == "0", "Grupo MN", "Grupo MP")) %>% 
    rename(`Frequência` = Freq)
  
  g1 <- perc %>% 
    ggplot(aes(x = lista2, y = `Frequência` , fill = lista1)) +
    geom_bar(stat='identity') + 
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa)) +
    labs(
      x = str_to_title(variavel), 
      title = paste("Frequência de", variavel," por grupo"),
      fill = "Grupo") 
  
  return(g1)
}

# funcao Teste de Hipóteses
permutacoes <- function(grupo_MN, grupo_MP, n = 10000){
  difobs <- mean(grupo_MN, na.rm = T) - mean(grupo_MP, na.rm = T)
  dif <-numeric(n)
  todos <- c(grupo_MN, grupo_MP)
  todos <- todos[! is.na(todos)]
  set.seed(2023)
  N <- length(todos)

  for (i in 1:n) {
    # permutar dados
    sorteio <- sample(todos, replace = F)
  
    g1_perm <- sorteio[1:(N/2)]
    g2_perm <- sorteio[((N/2)+1):N]
    dif[i] <- mean(g1_perm)-mean(g2_perm)
  }
  valorp<- 2 * length(dif[dif > abs(difobs) ])/n # cauda superior
  alpha <- 0.05
  
  tipo_teste <- "Teste permutação"
  
  #cat(paste("Teste permutação\n",
  #          "Hipotese Alternativa: Medias diferentes para os grupos\n",
  #          paste0("Nivel de significancia de ", alpha),
  #          "pvalor =", valorp), 
  #    "\n", if_else(valorp >= alpha, "Não rejeita-se H0", "Rejeita-se H0"))
  
  return(list(method = tipo_teste, p.value = valorp))
  } 

realizar_teste <- function(dataframe, variavel) {
  
  dataframefiltrado <- dataframe %>%
    mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 

  grupo_MN<- dataframefiltrado %>%
    filter(grupo == "MN") %>%
    pull(variavel)
  
  grupo_MP<- dataframefiltrado %>%
    filter(grupo == "MP") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_MN)
  shapiro2 <- shapiro.test(grupo_MP)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_MN, grupo_MP)
  } else {
    resultado_teste <- t.test(grupo_MN, grupo_MP, alternative = "two.sided") 
    return(resultado_teste)
  }
}

# Teste de hipóteses para dados categóricos
hipo_categorica <- function(dados, grupo, variavel){
  data_grupo <- dados %>% dplyr::select( !!sym(grupo) ) %>% pull( !!sym(grupo) )
  data_variavel <- dados %>% dplyr::select( !!sym(variavel) ) %>% pull( !!sym(variavel) )
  tab = xtabs(~ data_grupo + data_variavel) # tabela de frequencia
  return(fisher.test(tab))
}

# Função para tratar dados extremos nos testes de hipóteses
retira_extremos <- function(dados, coluna, ponto_corte){
  
  print_resumo <- function(res, momento){
    cat(
      paste("Resumo dos dados", momento, "da remoção:\n"),
      "Média:", mean(res, na.rm = T) %>% round(2),"\n",
      "Des. Padrão:", sd(res, na.rm = T) %>% round(2),"\n",
      "Nulos:", is.na(res) %>% sum(),"\n",
      "Total de observações:", res %>% length(),"\n\n")}
  
  cat("Foi encontrado observações extremas, elas serão retiradas.\n") 

  resumo <- dados %>% select(coluna) %>% pull(coluna)
  print_resumo(resumo, "antes")
  
  n_corte <- resumo[resumo > ponto_corte] %>% length()
  cat(paste(n_corte, "observações serão retirados entre nulos e extremos\n"))
  
  df_filtro <- dados %>% filter( !!sym(coluna) < ponto_corte)
  
  novo_resumo <- df_filtro %>% select(coluna) %>% pull(coluna)
  print_resumo(novo_resumo, "depois")
  
  return(df_filtro)
}

# Funcao tabela resumo de frequencia
funcao_tabela <- function(dados, grupo, variavel){
  return(
    dados %>% 
    tabyl( !!sym(grupo), !!sym(variavel), show_na = F) %>% 
    adorn_percentages() %>% 
    adorn_rounding(4) %>%  adorn_pct_formatting(digits = 2) %>% 
      kable(caption = "Tabela da proporção da variavel por grupo")
  )
}
```

### Idade:

```{r, fig.cap="Análise descritiva por grupo para a variável idade",out.width = "70%", fig.align='center'}
variavel <- "idade"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado
##resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Etnia:

```{r, fig.cap="Análise descritiva por grupo para a variável etnia",out.width = "70%", fig.align='center'}
variavel <- "etnia"
graficos_categoricos(df1$grupo, df1$etnia, variavel)
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
df_tab1 <- df1 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab1 %>% 
  mutate(etnia = ifelse(etnia == 1, "Branca",
                         ifelse(etnia == 2, "Parda", "Negra")))

funcao_tabela(tab, "Grupo", "etnia")
```

### Escolaridade:

```{r, fig.cap="Análise descritiva por grupo para a variável escolaridade",out.width = "70%", fig.align='center'}
variavel <- "escolaridade"
graficos_categoricos(df1$grupo, df1$escolaridade, variavel)
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(escolaridade = ifelse(escolaridade == 0, "4ª série",
                        ifelse(escolaridade == 1, "Fundamental",
                        ifelse(escolaridade == 2, "Ensino Médio", 
                        ifelse(escolaridade == 3, "Ensino técnico",
                        ifelse(escolaridade == 4, "Superior",
                                                  "Pós-graduação"))))))
  
funcao_tabela(tab, "Grupo", "escolaridade")
```

### Há quantos anos foi a gestação de interesse :

```{r, fig.cap="Análise descritiva por grupo para a variável há quantos anos foi a gestação de interesse",out.width = "70%", fig.align='center'}
variavel = "num_gestacoes"
graficos_categoricos(df1$grupo, df1$num_gestacoes, "Há quantos anos foi a gestação de interesse")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Peso da mulher:

```{r, fig.cap="Análise descritiva por grupo para a variável peso",out.width = "70%", fig.align='center'}
variavel = "peso"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### IMC:

```{r, fig.cap="Análise descritiva por grupo para a variável IMC",out.width = "70%", fig.align='center'}
variavel = "imc"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Percentual de gordura:

```{r, fig.cap="Análise descritiva por grupo para a variável gordura",out.width = "70%", fig.align='center'}
variavel = "gordura"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão Sistólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão sistólica",out.width = "70%", fig.align='center'}
variavel = "pressao_sis"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão Diastólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão diastólica",out.width = "70%", fig.align='center'}
variavel = "pressao_dias"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão arterial média:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão média",out.width = "70%", fig.align='center'}
variavel = "pressao_media"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de cintura:

```{r, fig.cap="Análise descritiva por grupo para a variável cintura",out.width = "70%", fig.align='center'}
variavel = "cintura"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de abdômen:

```{r, fig.cap="Análise descritiva por grupo para a variável circunferência do abdômen",out.width = "70%", fig.align='center'}
variavel = "abdomen"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável quadril",out.width = "70%", fig.align='center'}
variavel = "quadril"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Relação cintura vs quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável de relação da cintura vs quadril",out.width = "70%", fig.align='center'}
variavel = "cintura_quadril"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Neutrófilos:

```{r, fig.cap="Análise descritiva por grupo para a variável neutrófilos",out.width = "70%", fig.align='center'}
variavel = "neu"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Linfócitos:

```{r, fig.cap="Análise descritiva por grupo para a variável linfócitos",out.width = "70%", fig.align='center'}
variavel = "lym"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Razão neutrófilo/linfócito NLR:

```{r, , fig.cap="Análise descritiva por grupo para a variável NLR",out.width = "70%", fig.align='center'}
variavel = "nlr"

df_filtro <- retira_extremos(df1, variavel, 4)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Colesterol Total:

```{r, fig.cap="Análise descritiva por grupo para a variável colesterol total",out.width = "70%", fig.align='center'}
variavel = "colesterol_total"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável HDL",out.width = "70%", fig.align='center'}
variavel = "hdl"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### LDL dosado:

```{r, fig.cap="Análise descritiva por grupo para a variável LDL dosado",out.width = "70%", fig.align='center'}
variavel = "ldl_dosado"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### VLDL:

```{r, fig.cap="Análise descritiva por grupo para a variável VLDL",out.width = "70%", fig.align='center'}
variavel = "vldl"

df_filtro <- retira_extremos(df1, variavel, 45)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Não-HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável Não-HDL",out.width = "70%", fig.align='center'}
variavel = "nao_hdl"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Triglicérides:

```{r, fig.cap="Análise descritiva por grupo para a variável triglicérides",out.width = "70%", fig.align='center'}
variavel = "triglicerides"
df_filtro <- retira_extremos(df1, variavel, 300)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Hemoglobina glicada HbA1c:

```{r, fig.cap="Análise descritiva por grupo para a variável HbA1c",out.width = "70%", fig.align='center'}
variavel = "hba1c"

df_filtro <- retira_extremos(df1, variavel, 6)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Creatinina:

```{r, fig.cap="Análise descritiva por grupo para a variável creatinina",out.width = "70%", fig.align='center'}
variavel = "hba1c"
df_filtro <- retira_extremos(df1, variavel, 4)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Ritmo de filtração glomerular:

```{r, fig.cap="Análise descritiva por grupo para a variável filtração glomerular",out.width = "70%", fig.align='center'}
variavel = "filtr_glomerular"
df_filtro <- retira_extremos(df1, variavel, 400)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### TGP/ALT:

```{r, fig.cap="Análise descritiva por grupo para a variável TGP/ALT",out.width = "70%", fig.align='center'}
variavel = "tgp_alt"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### TGO/AST:

```{r, fig.cap="Análise descritiva por grupo para a variável TGO/AST",out.width = "70%", fig.align='center'}
variavel = "tgo_ast"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Ácido úrico:

```{r, fig.cap="Análise descritiva por grupo para a variável ácido úrico",out.width = "70%", fig.align='center'}
variavel = "acido_urico"

df_filtro <- retira_extremos(df1, variavel, 8)
graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### CK:

Há apenas 2 observações no grupo MN de CK, logo, não é possível realizar o teste de médias.

```{r, fig.cap="Análise descritiva por grupo para a variável CK",out.width = "70%", fig.align='center'}
variavel = "ck"
graficos(df1, "grupo", variavel)

df1 %>%
  mutate(Grupo = ifelse(grupo == "0", "MN", "MP")) %>%
  group_by(grupo) %>% 
  summarise(
    Nulos = sum(is.na(ck)),
    `Nao nulos` = sum(!is.na(ck))
    ) %>% kable(caption = "Quantidade de nulos e não nulos por grupo de CK")
```

### Gama GT:

```{r, fig.cap="Análise descritiva por grupo para a variável Gama GT",out.width = "70%", fig.align='center'}
variavel = "gama_gt"

df_filtro <- retira_extremos(df1, variavel, 50)
graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Há quantos anos foi a gestação de interesse

```{r, fig.cap="Análise descritiva por grupo para a variável quantos anos passou-se do evento",out.width = "70%", fig.align='center'}
variavel = "quantos_anos_evento"
graficos_categoricos(df2$grupo, 
                     df2$quantos_anos_evento, "quantos anos foi a gestação de interesse")

tab = xtabs(~ df2$grupo + df2$quantos_anos_evento) # tabela de frequencia
teste <- fisher.test(tab, simulate.p.value = T)
teste$method <- "Fisher's Exact Test for Count Data simulated"

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Peso do bebê:

```{r, fig.cap="Análise descritiva por grupo para a variável peso do bebê",out.width = "70%", fig.align='center'}
variavel = "peso_bebe"
graficos(df2, "grupo", variavel) 
teste <- realizar_teste(df2, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Tipo Parto

```{r, fig.cap="Análise descritiva por grupo para a variável tipo de parto",out.width = "70%", fig.align='center'}
df2_filtro <- df2 %>% 
  filter(tipo_parto != "<NA>")

variavel = "tipo_parto"
graficos_categoricos(df2_filtro$grupo, df2_filtro$tipo_parto, "Tipo de parto") 
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
df_tab2 <- df2 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab2 %>% 
  mutate(tipo_parto = ifelse(tipo_parto == 0, "Normal",
                      ifelse(tipo_parto == 1, "Cesariana", 
                      ifelse(tipo_parto == 2, "Fórceps", "Induzido"))))

funcao_tabela(tab, "Grupo", "tipo_parto")
```

### Prematuro

```{r, fig.cap="Análise descritiva por grupo para a variável prematuro",out.width = "70%", fig.align='center'}
df2_filtro <- df2 %>% 
  filter(prematuro != "<NA>")

variavel = "prematuro"
graficos_categoricos(df2_filtro$grupo, df2_filtro$prematuro, "prematuro") 
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab2 %>% 
  mutate(prematuro = ifelse(prematuro == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "prematuro")
```

### PAI-1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável PAI-1",out.width = "70%", fig.align='center'}
variavel = "pai1"
graficos(df3, "grupo", variavel) 
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Trombomodulina ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável trombomodulina",out.width = "70%", fig.align='center'}
variavel = "trombomodulina"
graficos(df3, "grupo", variavel) 
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### ADMA ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável ADMA",out.width = "70%", fig.align='center'}
variavel = "adma"
df_filtro <- retira_extremos(df3, variavel, 250)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### AA-AT1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável AA-AT1",out.width = "70%", fig.align='center'}
variavel = "aaat1"
graficos(df3, "grupo", variavel)
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 sem previsões

```{r, fig.cap="Análise descritiva por grupo para a variável sflt1 sem previsões",out.width = "70%", fig.align='center'}
variavel = "sflt1"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 com previsões feitas pelo ajuste da curva

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo ajuste da curva",out.width = "70%", fig.align='center'}
df_est = results %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_geral = ifelse(is.na(sflt1), concentration.est, sflt1))

variavel = "sflt1_geral"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 com previsões feitas pelo método da Luiza

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo método da Luiza",out.width = "70%", fig.align='center'}
df_est = resultado_luiza %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_luiza = ifelse(is.na(sflt1), `Ajuste Luiza`, sflt1))

variavel = "sflt1_luiza"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Dímero-D ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável dimero",out.width = "70%", fig.align='center'}
variavel = "dimero"

df_filtro <- retira_extremos(df4, variavel, 1000)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Hipertensão

```{r, fig.cap="Análise descritiva por grupo para a variável hipertensão",out.width = "70%", fig.align='center'}
variavel = "hipertensao"
graficos_categoricos(df5$grupo, df5$hipertensao, "Hipertensão")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
df_tab5 <- df5 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab5 %>% 
  mutate(hipertensao = ifelse(hipertensao == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "hipertensao")
```

### Anti-hipertensivo

```{r, fig.cap="Análise descritiva por grupo para a variável anti-hipertensivo",out.width = "70%", fig.align='center'}
variavel = "anti_hiper"
graficos_categoricos(df1$grupo, df1$anti_hiper, "Anti-hipertensivo")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(anti_hiper = ifelse(anti_hiper == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "anti_hiper")
```

### Diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável diabetes",out.width = "70%", fig.align='center'}
variavel = "diabetes"
graficos_categoricos(df5$grupo, df5$diabetes, "Diabetes")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(diabetes = ifelse(diabetes == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "diabetes")
```

### Medicamento para diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para diabetes",out.width = "70%", fig.align='center'}
variavel = "medic_diabetes"
graficos_categoricos(df1$grupo, df1$medic_diabetes, "Medicamento para diabetes")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_diabetes = ifelse(medic_diabetes == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "medic_diabetes")
```

### Hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável hipercolesterolemia",out.width = "70%", fig.align='center'}
variavel = "hipercolesterolemia"
graficos_categoricos(df5$grupo, df5$hipercolesterolemia,"Hipercolesterolemia")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(hipercolesterolemia = ifelse(hipercolesterolemia == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "hipercolesterolemia")
```

### Medicamento para hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para hipercolesterolemia",out.width = "70%", fig.align='center'}
variavel = "medic_hipercol"
graficos_categoricos(df1$grupo, df1$medic_hipercol, 
                     "Medicamento para hipercolesterolemia")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_hipercol = ifelse(medic_hipercol == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "medic_hipercol")
```

### Fumantes

```{r, fig.cap="Análise descritiva por grupo para a variável fumantes",out.width = "70%", fig.align='center'}
variavel = "tabagista"
graficos_categoricos(df1$grupo, df1$tabagista, "Fumantes")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
#resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(tabagista = ifelse(tabagista == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "tabagista")
```

## Resumo testes de hipóteses


Para os dados numéricos, os testes tiveram por hipótese geral:


\begin{eqnarray}
        {
        \left\{\begin{array}{lcc}
        H_{0}: {\mu_{Grupo~MN} = \mu_{Grupo~MP}} \\
        H_{1}: {\mu_{Grupo~MN} \neq \mu_{Grupo~MP}}
        \end{array}\right.
        }    \nonumber
    \end{eqnarray}


Caso os dados atendessem a suposição de normalidade para os grupos, foi aplicado o *Teste T* para comparação da média de dois grupos. Caso contrário, o *Teste de Permutação* foi aplicado como teste não paramétrico. Em suma, deseja-se avaliar se a média entre os grupos é igual para uma dada variável ou se há diferença.


Para as variáveis qualitativas, o Teste Exato de Fisher para tabelas de contingência $2~\cdot~m$ foi aplicado sobre a hipótese nula de que a proporção das categorias fossem iguais para ambos grupos (*MN* e *MP*).


Em seguida, será apresentado o resumo de todos testes de hipóteses aplicados as variáveis.


```{r}
tabela_resumo_ordenada <- tabela_resumo %>% arrange(Pvalor) 

tabela_resumo_ordenada %>% 
  kable(caption = "Resumo de todos os resultados dos testes")
```

Resumo Descritivas favoráveis para o estudo sobre as variáveis que impactam na média ou frequência dentro do grupo *Grupo MN* e *Grupo MP* para um nível de significância de $\alpha = 0,05$.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.05) %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 5% de significância")
```

Caso fosse assumido um nível de significância de $\alpha = 0,10$, as seguintes variáveis seriam candidatas a impactar no grupo.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.1) %>% 
  mutate("Conclusão" = "Rejeita-se H0") %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 10% de significância")
```

## Modelo Linear Generalizado para hipertensão

```{r}
library(car)

## adicionando "2" nos nomes que são repetidos

posicoes_duplicadas <- which(duplicated(df1$iniciais))
df1$iniciais[posicoes_duplicadas] <- paste0(df1$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df3$iniciais))
df3$iniciais[posicoes_duplicadas] <- paste0(df3$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df4$iniciais))
df4$iniciais[posicoes_duplicadas] <- paste0(df4$iniciais[posicoes_duplicadas], "2")

## juntando data frames

dfreg <- df1 %>%
  left_join(df3, by = "iniciais") %>%
  left_join(df4, by = "iniciais")

dfreg %>% head()

## data frame só com as variáveis que eu vou precisar

dfreg<- cbind(dfreg$iniciais, dfreg$pressao_sis, dfreg$pressao_dias, dfreg$grupo.x, dfreg$idade, dfreg$tabagista, dfreg$imc, dfreg$gordura, dfreg$cintura, dfreg$quadril, dfreg$cintura_quadril, dfreg$colesterol_total, dfreg$hdl, dfreg$ldl_dosado, dfreg$triglicerides, dfreg$hba1c, dfreg$pai1, dfreg$aaat1, dfreg$dimero)

# nome pras colunas do df regressao

colnames(dfreg) <- c("iniciais", "pressao_sis", "pressao_dias", "grupo", "idade", "tabagista", "imc", "gordura", "cintura", "quadril", "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides", "hba1c", "pai1", "aaat1", "dimero")

## colocando em ordem crescente a quantidade de na presentes em cada coluna

sort(colMeans(is.na(dfreg)))
```


```{r}
# novo df que será usado para a regressão

dfmodelo <- dfreg[, c("iniciais","pressao_sis", "pressao_dias","grupo", "idade", "tabagista", "imc", "gordura", "cintura", "quadril","cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides")] %>% na.omit %>% as_tibble()


var_cat <- c("iniciais", "grupo")

dfmodelo <- dfmodelo %>% mutate_at(vars(-var_cat), as.numeric)

dfmodelo$alta_pressao <- ifelse(dfmodelo$pressao_sis > 140 | dfmodelo$pressao_dias > 90, 1, 0)

realizar_teste2 <- function(dataframe, variavel) {

  grupo_1<- dataframe %>%
    filter(alta_pressao == "0") %>%
    pull(variavel)
  
  grupo_2<- dataframe %>%
    filter(alta_pressao == "1") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_1)
  shapiro2 <- shapiro.test(grupo_2)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_1, grupo_2)
  } else {
    resultado_teste <- t.test(grupo_1, grupo_2, alternative = "two.sided") 
    return(resultado_teste)
  }
}

col_teste_num <- c("pressao_sis", "pressao_dias","idade", "imc", "gordura", "cintura", "quadril",
               "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides")

tabela_resumo <-  resumo_testes( realizar_teste2(dfmodelo, "idade"),"idade")

for (col in col_teste_num[-c(1,2,3)]) {
    teste_hiper <- realizar_teste2(dfmodelo, col)
    resultado <- resumo_testes(teste_hiper, col)
    tabela_resumo <- rbind(tabela_resumo, resultado)
}

tabela_resumo %>% arrange(Pvalor)


library(lmtest)
library(DescTools)
library(nnet)
library(psych)
pairs.panels(dfmodelo[4:12])

# aqui entraram só as variáveis com p-valor < 0.3
modelo<- glm(alta_pressao ~ grupo + imc + cintura + cintura_quadril + idade + quadril + gordura + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo)
vif(modelo)

# aqui fica apenas grupo, idade e ldl
# no gráfico da pra ver que ia dar problema de multicolinearidade
modelo1<- glm(alta_pressao ~ grupo + idade + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo1)
vif(modelo1) #vif ta top

# colocando cada uma das seguintes variáveis: imc, gordura, cintura, quadril e cintura_quadril

modelo2<- glm(alta_pressao ~ grupo + idade + imc + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo2)

modelo3<- glm(alta_pressao ~ grupo + idade + gordura + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo3)

modelo4<- glm(alta_pressao ~ grupo + idade + cintura + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo4)

modelo5<- glm(alta_pressao ~ grupo + idade + quadril + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo5)

modelo6<- glm(alta_pressao ~ grupo + idade + cintura_quadril + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo6)


# Stepwise para definir variaveis
modelostepwise <- step(modelo, direction = "both", trace = 1, k = log(nrow(dfmodelo)))
summary(modelostepwise)


coeftest(modelo)
#razao de chances
exp(coef(modelo))

#hnp(modelo) #verifecar pressuposto
# Descrição
# Gera gráficos (semi) normais com envelopes de simulação para diagnósticos comuns a partir de modelos ajustados
# para uma variedade de classes de modelo. A função hnp() é escrita de forma que seja relativamente fácil estendê-la
# a novas classes de modelos e diferentes diagnósticos que ainda não estão implementados. Alguns exemplos
# conjuntos de dados estão incluídos.
```


# Referências

https://dl.acm.org/doi/pdf/10.1145/503506.503509

https://est.ufba.br/sites/est.ufba.br/files/kim/matd49-aula04-fisher.pdf

https://www.jstor.org/stable/2527460?seq=1

http://ndl.ethernet.edu.et/bitstream/123456789/15304/1/9103.pdf

https://janalin.github.io/analyse-ELISA/results.html

https://cran.r-project.org/web/packages/drc/drc.pdf

https://nomato.files.wordpress.com/2015/03/curvas-de-dose-resposta-no-software-r.pdf