---
#title: "Projeto I"
#author:
#- Bárbara Oliveira Ribeiro
#- Nathalia Gabriella Ferreira dos Santos
#date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    fig_caption: yes
#header-includes: \usepackage[brazil]{babel}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, # true mostra o codigo
	message = FALSE,
	warning = FALSE
)
#options(OutDec = ",")
```

```{r pacotes, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(patchwork) # para parcionar os graficos
library(kableExtra)
library(janitor)
```

```{r limpa_env}
rm(list = ls())
```

```{r tema_graficos}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```

```{r}
# Função Resumo testes de hipoteses
resumo_testes <- function(teste, variavel){
    pvalor <- teste$p.value
    metodo <- teste$method  
    alpha <- 0.05
    conclusao <- if_else(pvalor >= alpha, "Não significativo", "Significativo")
    
    lista <- list(
      Nome = variavel,
      `Método` = metodo,
      Pvalor = pvalor %>% round(4),
      `Conclusão` = conclusao)
    
    return(lista %>% as_tibble() )
}
```

# Introdução

A pré-eclâmpsia, caracterizada por hipertensão arterial e danos a órgãos, é uma complicação gestacional que geralmente se manifesta após a 20ª semana de gravidez. Ela é frequentemente acompanhada de sintomas como aumento da pressão arterial, presença de proteína na urina, edema e, em casos mais graves, eclâmpsia, que pode resultar em convulsões. Esta condição não apenas representa uma ameaça direta à saúde da mãe, mas também pode ter sérias consequências para o feto, incluindo restrição de crescimento intrauterino e parto prematuro. A magnitude do problema da pré-eclâmpsia é evidente nas estatísticas globais de saúde materna. A pré-eclâmpsia é um fator de risco para complicações de saúde a longo prazo para a mãe, como doença cardíaca e hipertensão.

Neste estudo, realizamos uma análise estatística abrangente. Isso incluiu a utilização de regressão logística para identificar fatores relevantes associados à pré-eclâmpsia, uma análise descritiva dos dados coletados para melhor compreensão do perfil das pacientes, bem como o cálculo amostral para determinar o tamanho ideal da amostra para garantir resultados confiáveis. Além disso, investigamos a curva logística de quatro parâmetros para preencher eventuais valores faltantes nos dados. Esta análise estatística detalhada visa aprimorar nossa compreensão da pré-eclâmpsia, suas causas potenciais e possíveis estratégias de prevenção, contribuindo assim para o avanço das práticas médicas e políticas de saúde relacionadas à gravidez.

Através deste estudo multidisciplinar, esperamos fornecer insights valiosos para profissionais de saúde, pesquisadores e formuladores de políticas, a fim de melhorar o diagnóstico precoce, o tratamento e a prevenção da pré-eclâmpsia, com o objetivo de promover a saúde materna e neonatal em todo o mundo.

Este trabalho tem como objetivo explorar uma ampla gama de dados relacionados às mulheres que tiveram ou não pré-eclâmpsia, incluindo características físicas, resultados de exames laboratoriais, histórico de doenças e hábitos. A pré-eclâmpsia, uma condição médica complexa que afeta mulheres grávidas, é de grande interesse para a comunidade médica devido às suas implicações para a saúde materna e neonatal.

# Objetivo

## Objetivo Geral

Conduzir uma investigação abrangente sobre a pré-eclâmpsia, incluindo planejamento amostral, análise das diferenças entre mulheres saudáveis (MN) e aquelas com pré-eclâmpsia (MP), previsão de resultados relevantes não alcançados pelos equipamentos atuais e estudo da relação entre pré-eclâmpsia e hipertensão, um dos principais fatores de risco.

## Objetivos Específicos

 - Realizar o dimensionamento amostral, em que será calculado o tamanho da amostra de acordo com o erro esperado.
 - Estimar as concentração de sFlt-1 que não puderam ser determinadas pelo equipamento de medição.
 - Determinar quais fatores predizem a hipertensão, bem como realizar essa predição.
 - Realizar testes para compreender como e comportam os grupos de mulheres com e sem pré-eclâmpsia.

# Metodologia

## Variáveis utilizadas

As variáveis analisadas foram:

**Idade**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Anos

**Escolaridade**

 - Tipo de Variável: Categórica (Nível de Educação)

 - Unidades de Medida: N/A

 - Níveis:

   - 0 – Educação infantil

   - 1 - Fundamental

   - 2 - Médio

   - 3 - Superior

   - 4 - Pós-graduação

   - 5 - Técnico

**Número de Gestações**

 - Tipo de Variável: Numérica

 - Unidades de Medida: N/A

**Anos Desde a Última Gestação**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Anos

**Peso da Mulher**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Kilogramas

**Índice de Massa Corporal (IMC)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: N/A

**Percentual de Gordura**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Porcentagem

**Pressão Sistólica**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mmHg (milímetros de mercúrio)

**Pressão Diastólica**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mmHg (milímetros de mercúrio)

**Pressão Arterial Média**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mmHg (milímetros de mercúrio)

**Circunferência de Cintura**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Centímetros

**Circunferência de Abdômen**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Centímetros

**Circunferência de Quadril**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Centímetros

**Relação Cintura/Quadril**

 - Tipo de Variável: Numérica

 - Unidades de Medida: N/A

**Neutrófilos**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Contagem Absoluta

**Linfócitos**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Contagem Absoluta

**Razão Neutrófilo/Linfócito (NLR)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: N/A

**Colesterol Total**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**HDL (High-Density Lipoprotein/ Lipoproteína de Alta Densidade)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**LDL Dosado (Low-Density Lipoprotein/ Lipoproteína de Baixa Densidade)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**VLDL (Very Low-Density Lipoprotein/ Lipoproteína de Muito Baixa Densidade)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**Não-HDL (Non-High-Density Lipoprotein/ Lipoproteína de Não Alta Densidade)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**Triglicérides**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**Hemoglobina Glicada (HbA1c)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Porcentagem

**Creatinina**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**Ritmo de Filtração Glomerular**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mL/min (mililitros por minuto)

**TGP/ALT (Transaminase Glutâmica Pirúvica / Alanina Transaminase)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: U/L (unidades por litro)

**TGO/AST (Transaminase Glutâmica Oxalacética / Aspartato Transaminase)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: U/L (unidades por litro)

**Ácido Úrico**

 - Tipo de Variável: Numérica

 - Unidades de Medida: mg/dL (miligramas por decilitro)

**CK (Creatina Quinase)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: U/L (unidades por litro)

**Gama GT (Gama Glutamiltransferase)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: U/L (unidades por litro)

**Peso do Bebê**

 - Tipo de Variável: Numérica

 - Unidades de Medida: Kilogramas

**PAI-1 (Inibidor-1 do Ativador de Plasminogênio)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: ng/mL (nanogramas por mililitro)

**Trombomodulina**

 - Tipo de Variável: Numérica

 - Unidades de Medida: ng/mL (nanogramas por mililitro)

**ADMA (Asymmetric Dimethylarginine/ Dimetilarginina assimétrica)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: ng/mL (nanogramas por mililitro)

**sFlt1 (Soluble Fms-Like Tyrosine Kinase-1)**

 - Tipo de Variável: Numérica

 - Unidades de Medida: N/A (cálculos necessários)

**Dímero-D**

 - Tipo de Variável: Numérica

 - Unidades de Medida: ng/mL (nanogramas por mililitro)

**Tabagismo**

 - Tipo de Variável: Categórica Nominal

 - Níveis:

   - 0 – Não fumante

   - 1 - Fumante  
   
**Grupo (em relação à pré-eclâmpsia)**

 - Tipo de Variável: Categórica Nominal

 - Níveis:

   - 1 – Não teve pre-eclâmpsia

   - 2 - Teve pré-eclâmpsia  

## Tamanho Amostral

Para o cálculo do tamanho da amostra onde o objetivo do estudo era comparar dois grupos: grupo tratamento com um controle, no contexto do trabalho o grupo controle seriam as mulheres que tiveram gestações saudáveis *(MN)* e o grupo tratamento seriam mulheres que tiveram pré-eclâmpsia *(MP)*. Optou-se por usar a variância da pressão sistólica porque, segundo a Sociedade Brasileira de Cardiologia, ela é primerio indício para causa de doença cardiovascular, ou seja, está sendo usado como desfecho para o aumento da pressão. As variâncias para os grupos serão denotados por $\sigma^2_{MN}$ e $\sigma^2_{MP}$, respectivamente, e foram obtidas por meio de estudo piloto e repassado pela cliente para o estudo.

As variâncias para a **pressão sistólica** são:

-   Grupo MN: 196,90

-   Grupo MP: 514,95

Então, escolhendo um nível de significância de $\alpha = 0,05$ e um poder de teste de $\beta = 0,10$, tem-se que os resultados encontrados estão na *Tabela 1*.

O *delta* ($\delta$) denota a diferença das médias do grupo MN e MP, $|\mu_{MN} - \mu_{MP}| < \delta$.


## Curva de concentração do Sflt1

Devido ao não registro de valores de *concentração* de Sflt1 (provavelmente devido a baixa acurácia do equipamento na medição para valores pequenos de concentração), e tendo o resultado da *absorbância* observada, foi solicitado a estimação teórica dessas concentrações.

É conhecido por meio da literatura que essa concentração a ser estimada segue uma equação conhecida como **Four parameter logistic regression** (Modelo de Regressão Logística de 4 Parâmetros) a qual é muito usada para dados de ensaio imunoabsorvente enzimático - ELISA (Enzyme-linked immunosorbent assay). Cabe então, a estimação dos parâmetros da curva por meio da regressão específica do problema.

Esse modelo de regressão possui como variável resposta a **absorbância** e como variável explicativa a **concentração**. Entretanto, o objetivo final da estimação é predizer valores de concentração para uma absorbância conhecida. Assim, a princípio usou-se os dados teóricos disponibilizados para estimar os parâmetros. Foi buscado na literatura ajustes semelhantes e optou-se pela implementação *LL2.4* contida no pacote *drc* (Analysis of Dose-Response Curves ou Análise de Curvas Dose-Resposta) implementado no R-Studio.

A função *LL2.4* fornece a reparametrização da função por meio da transformação log da concentração e no parâmetro do ponto de inflexão, dado por:

![Fórmula da parametrização usada](foto_funcao.png){width="190"}

-   **b** indica a inclinação da curva (Slope)

-   **c** indica o limite inferior (Amin)

-   **d** indica o limite superior (Amax)

-   **e** indica o ponto de inflexão (ED50 que nessa parametrização é log2ED50)

Além disso, a função permite auto-inicialização (caso o algoritmo seja iterativo e parta de um "chute inicial"), e a imputação dos nomes dos parâmetros. Como está sendo usada a transformação $log_{2}$ para estimar os parâmetros, para conversão final da concentração estimada será aplicada a inversa da transformação para achar o valor real da concentração.

O resultado encontrado para a estimação dos parâmetros está na *Tabela 2*.

Para testar a significância dos parâmetros, um intervalo de confiança foi obtido, *Tabela 3*. Exceto o parâmetro de máximo e mínimo, conclui-se que todos demais são significativos. Pelo método do $p-valor$, caso o nível de significância $\alpha = 0,10$, apenas o ponto de máximo seria não significativo.

Por meio da *Figura 1* é possível notar o quão bem a curva se ajustou aos dados teóricos.

### Estimação da concentração por imputação do limite inferior

Para estimação da concentração, como foi feita uma parametrização, a *Log2-concentração* será obstida e então convertida para escala padrão. Buscando-se na literatura referências, foi encontrado que além dos valores estimados, como deseja-se estimar concentrações abaixo do limite inferior, um novo candidato a mínimo deveria ser estipulado. Nesse caso, optou-se pelo mínimo ser o menor valor de concentração observado na amostra (0.048). Esse valor está contido no Intervalo de Confiança para o mínimo. Os demais coeficientes serão os mesmos estimados.

As concentrações encontradas podem ser vistas na *Tabela 5*.

## Análises descritivas

Em seguida foi levantado algumas medidas de resumo para as variáveis de interesse contidas no banco de dados. Essas descritivas foram levantadas com o objetivo de avaliar principalmente o efeito da variável em cada grupo, *Grupo MN* e *Grupo MP*.

Em síntese, as medidas descritivas escolhidas para os dados contínuos refletem:

-   Boxplot: comparativo do comportamento dos dados para cada grupo e se há informações discrepantes;

-   Tabela: medidas de resumos de tendência central e variabilidade, indicativo de nulos e número de observações encontradas e

-   Histograma: a frequência geral da variável de interesse.

Caso fossem encontrados dados extremos, visando melhores estimativas, eles foram retirados das medidas de resumo. Seus resultados gerais antes e após a retirada foram colocados em uma tabela chamada "Resumo de retirada".

Para os dados categóricos, a medida descritiva escolhida foi um gráfico de barras para avaliar a proporção de cada grupo (*MN* e *MP*) dentro de cada categoria. Dentre algumas variáveis categóricas, foi gerado uma tabela de frequência para avaliar a proporção da categoria dentro de cada grupo (*MN* e *MP*).

Essas análises descritivas estão contidas na seção de **Apêndice** desse relatório.

## Resumo testes de hipóteses

Para os dados numéricos, os testes tiveram por hipótese geral:

```{=tex}
\begin{eqnarray}
        {
        \left\{\begin{array}{lcc}
        H_{0}: {\mu_{Grupo~MN} = \mu_{Grupo~MP}} \\
        H_{1}: {\mu_{Grupo~MN} \neq \mu_{Grupo~MP}}
        \end{array}\right.
        }    \nonumber
    \end{eqnarray}
```

Caso os dados atendessem a suposição de normalidade para os grupos, foi aplicado o *Teste T* para comparação da média de dois grupos. Caso contrário, o *Teste de Permutação* foi aplicado como teste não paramétrico. Em suma, deseja-se avaliar se a média entre os grupos é igual para uma dada variável ou se há diferença.

Para as variáveis qualitativas, o *Teste Exato de Fisher* para tabelas de contingência $2~\cdot~m$ foi aplicado sobre a hipótese nula de que a proporção das categorias fossem iguais para ambos grupos (*MN* e *MP*).

## Regressão Logística

A regressão logística é uma técnica estatística que explora as relações entre variáveis em estudos com múltiplas categorias. No nosso contexto, a regressão logística é usada para prever a probabilidade de hipertensão em mulheres, considerando diversas variáveis explicativas.

A regressão logística binária é particularmente útil para problemas de classificação com duas categorias de resultados, como "sim" ou "não". No nosso caso, a variável dependente é a presença ou ausência de hipertensão, representada como "0" (ausência) e "1" (presença).

Para fins deste estudo, definimos **hipertensão** como pressão sistólica e diastólica acima de 140mmHg e 90 mmHg, respectivamente, independentemente das respostas ao questionário.

Para a construção do modelo de regressão logística, começamos excluindo variáveis com um alto número de valores faltantes.
Nossa seleção de variáveis para o modelo inicial baseou-se em testes de associação e diferença entre médias. Variáveis com p-valores menores ou iguais a 0,25 foram incluídas no modelo. Este valor de corte mais elevado foi escolhido para a pré-seleção das variáveis, considerando que variáveis com p-valores maiores seriam improváveis de contribuir significativamente para o modelo.

A multicolinearidade, que ocorre quando as variáveis independentes possuem relações lineares aproximadas, foi avaliada usando uma matriz de dispersão e correlação, bem como o cálculo do Fator de Inflação da Variância (VIF). Detectamos multicolinearidade significativa entre IMC, gordura, cintura e quadril, o que poderia afetar a significância dos coeficientes de regressão. Portanto, optamos por não incluir simultaneamente essas variáveis no modelo final.

Nosso **modelo final** inclui as variáveis **"grupo"** e **"IMC"**. A inclusão de "LDL" foi realizada em um modelo separado, devido à sua relevância teórica para a variável resposta. Devido à multicolinearidade, não foi possível incluir as variáveis "IMC" e "gordura" no mesmo modelo. No entanto, considerando a importância da variável "gordura", fornecemos outras opções de modelo:

- Modelo 1: "grupo" e "IMC"
- Modelo 2: "grupo", "IMC" e "LDL"
- Modelo 3: "grupo" e "gordura"
- Modelo 4: "grupo" e "LDL"

As tabelas geradas apresentam os resultados da análise, incluindo a Razão de Chances (OD), Intervalo de Confiança de 95% (IC 95%) e p-valor. A presença do valor "1" no intervalo de confiança sugere que a variável não é estatisticamente significativa.

Algumas classificações para o Índice de Massa Corporal (IMC) são:

- IMC de 25 a menor que 30: Sobrepeso
- IMC de 30 a menor que 35: Obesidade Grau I
- IMC de 35 a menor que 40: Obesidade Grau II (considerada severa)
- IMC maior que 40: Obesidade Grau III (considerada mórbida)

As probabilidades de uma mulher ter hipertensão em relação a esses IMCs, bem como a associação com os grupos, foram calculadas.

# Resultados

## Tamanho Amostral

A *Tabela 1* consta os resultados. 

Além disso, dados as médias para a **pressão sistólica** também do estudo piloto, são elas:

-   Grupo MN: 122.02

-   Grupo MP: 132.05


Averiguou-se qual seria a escolha do $\delta$ para o estudo, no caso: $\delta \approx 10$, logo nota-se que a tabela contempla esse valor.

```{r calc_amostral}
var1 <- 196.9
var2 <- 514.95
alpha <- 0.05
beta <- 0.1
delta <- c(0.5, 1, 2, 5, 10) # erro

z2 <- qnorm(1 - alpha/2)
zbeta <- qnorm(1 - beta)

#se o erro aumenta, o n diminui. peq erros maior n
n = ((var1 + var2) * (z2 + zbeta)^2) / (delta^2) 

tibble(
  "Delta" = delta,
  "Tamanho Amostral" = n %>% round()
) %>% 
  kable(
    caption = "Cálculo do tamanho amostral para diferentes erros",
    format.args = list(big.mark = "."))%>% 
  kable_styling("striped", full_width = F)
```

## Curva de concentração do Sflt1

```{r dados_curva}
resultado <- read_xlsx("curva.xlsx", sheet = "prev") # valores a serem preditos
resultado_luiza <- read_xlsx("curva.xlsx", sheet = "ajust") %>% 
  rename("Ajuste Luiza" = ajust)
```

```{r ajuste_curva}
library(drc)

data <- read_xlsx("dados_teoricos.xlsx")

new <- data.frame(
  conc = seq(0,50, 0.01)
)

# ajusta pelo metodo o LL2, no anterior era o LL. Esse eh o log2. dif minima entre ambos
drc.fit <- drm(abs ~ conc,
  data = data,
  fct = LL2.4( 
    names = c("Slope", "Amin", "Amax", "log2ED50")
    )
)

# Extraindo coefs
`Coeficientes Estimados` <- setNames(
  drc.fit$coefficients %>% round(4),
  c("Slope", "Amin", "Amax", "log2ED50")
)
cbind(`Coeficientes Estimados`) %>% kable(caption = "Valores estimados dos parâmetros")%>% 
  kable_styling("striped", full_width = F)

resumo <- summary(drc.fit)
```

```{r ic_ajuste}
confint(drc.fit) %>% round(3) %>% 
  kable(caption = "Intervalo de confiança para os parâmetros")%>% 
  kable_styling("striped", full_width = F)
```

Por meio da *Figura 2* é possível notar o comportamento da curva para os dados teóricos. Na *Figura 3*, tem-se as previsões para os dados abaixo da curva juntamente com os dados teóricos. A *tabela 5* consta todos resultados encontrados e foi deixado a referência repassada pela pesquisadora.

```{r fig.cap="Gráfico da curva com os dados teóricos",out.width = "70%", fig.align='center'}
plot(drc.fit, broken=F, xlab="Concentração", ylab="Absorbância", lwd=1.2, 
     cex=1.2, cex.axis=1.2, cex.lab=1.2)
```

### Análise de resíduos

A fim de validar alguns pressupostos da regressão e a partir da *Figura 4* (contida no *apêndice*), sobre os resíduos, nota-se que a homocedasticidade é válida.

```{r fig.cap="Gráfico dos valores ajustados pelos resíduos do modelo",out.width = "70%", fig.align='center'}
grafico_residuos <- ggplot(as_tibble(drc.fit$predres)) +
  geom_point(aes(`Predicted values`, Residuals),
     size = 3, color = cor_roxa) +
  geom_hline(yintercept = 0, lwd = 0.2) +
  labs(title = "Gráfico dos valores ajustados pelos resíduos") +
  theme_minimal()
```

De mesmo modo, sobre a *Tabela 4*, sobre a hipótese nula de que os resíduos possuem distribuição normal, para o mesmo $\alpha = 0,05$, dado o $p-valor$ observado, não rejeita-se a hipótese nula. Não foi encontrado pressuposto de normalidade dos resíduos na literatura, entretanto, optou-se por reportar.

```{r analise_residuos}
residuos <- drc.fit$predres[,2] 
teste <- residuos %>% shapiro.test()
resumo_testes(teste, "Resíduos") %>% 
  kable(caption = "Resumo teste de normalidade dos resíduos")%>% 
  kable_styling("striped", full_width = F)
```

Logo conclui-se que a estimação parece se adequar bem aos dados e pode-se seguir para a estimação da concentração por meio desses parâmetros.

```{r eval=FALSE, include=FALSE}
abs_predita <- predict(object = drc.fit, new)
new$abs_inter <- abs_predita # prevista
#new %>% head() # ver se precisamos elevar os dados ao quadrado

novo_data <- new %>% dplyr::select(conc, abs_inter) %>% rename(abs = abs_inter)
novo_df <- rbind(data, novo_data)
#plot(log2(novo_df$conc), novo_df$abs)
plot(log2(new$conc), new$abs, type = "line")
```

### Estimação da concentração por imputação do limite inferior

```{r}
prev.conc = resultado$abs

slope.est <- coef(drc.fit)[1]
Amax.est <- coef(drc.fit)[3]
log2EC50.est <- coef(drc.fit)[4]
# Set Amin to blank values
Amin <- min(resultado$abs) # media dos valores a serem previsto # zero também poderia ser

log2concentration.est <- sapply(
  prev.conc, function(A){(1/slope.est) * (log( ((Amax.est - A)/(A - Amin))) + log2EC50.est*slope.est)}
  )

results <- resultado %>% 
  dplyr::mutate(concentration.est = 2^log2concentration.est %>% round(3))

# resultados ja na escala desejada
left_join(results, resultado_luiza) %>% 
  arrange(abs) %>% 
  rename("Absorbância" = abs, "Concentração Estimada" = concentration.est) %>% 
  kable(
    caption = "Comparativo das estimações para concentração de Sflt1 abaixo da curva"
    )%>% 
  kable_styling("striped", full_width = F)
```

Nota-se que os valores preditos parecem estar próximos do esperado para o comportamento dos dados teóricos.

```{r fig.cap="Concentração preditas com dados teóricos",out.width = "70%", fig.align='center'}
novo_results <- results %>% rename(conc = concentration.est)

novo_df <- rbind(data, novo_results)
novo_df <- novo_df %>% mutate(log2conc = log2(conc))

nteo <- nrow(data)
nres <- nrow(results)
novo_df$Origem <- c(rep("Teórico",nteo), rep("Estimado",nres))

novo_df %>% 
  ggplot(aes(x = log2conc, y = abs, color = Origem)) +
  geom_point(size = 3) +
  labs(x = "Log-Concentração", y = "Absorbância", title = "Gráfico de adequação do modelo") +
  theme_minimal()
```

```{r}
# tirando pacotes que podem dar conflito com o dplyr
detach("package:drc", unload = TRUE)
```

```{r importa_dados}
df1 <- read_xlsx("dados.xlsx", sheet = "Dados Atuais")
df2 <- read_xlsx("dados.xlsx", sheet = "Dados Gestacionais")
df3 <- read_xlsx("dados.xlsx", sheet = "ELISAs")
df4 <- read_xlsx("dados.xlsx", sheet = "Imunoturbidimetria")
df5 <- read_xlsx("dados.xlsx", sheet = "Doenças Crônicas")
```

```{r funcoes_trata_dados}
##Funções para tratar os dados:

coluna_na_numerica <- function(lista, caracter = ".", substituto = ""){
  lista %>% 
    str_replace(. , pattern = ",", replacement = ".") %>%
    str_replace_na(. , replacement = "") %>% 
    ifelse(. == caracter, substituto, .) %>% as.numeric()
}

coluna_numerica <- function(lista){
  lista %>% 
    ifelse(. == 99999, NA, .) %>% as.numeric()
}
```

```{r tratamento_df1}
#### DF1: Dados Atuais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "ETNIA                1:branca   2:parda   3:negra",
  "IDADE    anos",
  "ESCOLARIDADE COMPLETA  0: 4ª série completa   1:fundamental completo 2:médio completo 3:ensino técnico completo 4:superior completo 5:pós-graduação completa",
  "NÚMERO GESTAÇÕES",
  "Peso (kg)",
  "IMC",
  "GORDURA (%)",
  "PRESSÃO SISTÓLICA (mmHg)",
  "PRESSÃO DIASTÓLICA (mmHg)",
  "PRESSÃO ARTERIAL MÉDIA",
  "CINTURA (cm)",
  "ABDÔMEN (cm)",
  "QUADRIL (cm)",
  "RELAÇÃO CINTURA/QUADRIL",
  "NEU (10³/µL)",
  "LYM (10³/µL)",
  "NLR",
  "Colesterol total (mg/dL)",
  "HDL (mg/dL)",
  "LDL (mg/dL) DOSADO",
  "VLDL (mg/dL)",
  "Não-HDL (mg/dL)",
  "Triglicérides (mg/dL)",
  "HbA1c (%)",
  "Creatinina (mg/dL)",
  "Ritmo de filtrção glomerular calculado",
  "TGP/ALT",
  "TGO/AST",
  "Ácido Úrico",
  "CK",
  "Gama GT",
  "USA ANTI-HIPERTENSIVO 0:não 1:sim",
  "USA MEDICAMENTO PARA DIABETES 0:não 1:sim",
  "USA MEDICAMENTO PARA HIPERCOLESTEROLEMIA 0:não 1:sim",
  "TABAGISTA 0: não   1:sim" 
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "etnia",
  "idade",
  "escolaridade",
  "num_gestacoes",
  "peso",
  "imc",
  "gordura",  
  "pressao_sis",
  "pressao_dias",
  "pressao_media", 
  "cintura",
  "abdomen",
  "quadril",
  "cintura_quadril",
  "neu",
  "lym",
  "nlr",
  "colesterol_total",
  "hdl",
  "ldl_dosado",
  "vldl",
  "nao_hdl",
  "triglicerides",
  "hba1c",
  "creatinina",
  "filtr_glomerular",
  "tgp_alt",
  "tgo_ast",
  "acido_urico",
  "ck",
  "gama_gt",
  "anti_hiper",
  "medic_diabetes",
  "medic_hipercol",
  "tabagista"
  )


df1 <- df1 %>% dplyr::select(all_of(colunas_interesse))
colnames(df1) <- renomear_colunas

grupos_nulos <- df1 %>% dplyr::select(grupo) %>% is.na()
df1 <- df1 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    etnia = coluna_numerica(etnia),
    escolaridade = as.factor(escolaridade),
    peso = coluna_numerica(peso),
    imc = coluna_na_numerica(imc, "#DIV/0!", NA) %>% coluna_numerica(),
    gordura = coluna_na_numerica(gordura) %>% coluna_numerica(),
    pressao_sis = coluna_numerica(pressao_sis),
    pressao_dias = coluna_numerica(pressao_dias),
    pressao_media = coluna_numerica(pressao_media),
    cintura = coluna_numerica(cintura),
    abdomen = coluna_numerica(abdomen),
    quadril = coluna_numerica(quadril),
    cintura_quadril = coluna_na_numerica(cintura_quadril, "#DIV/0!", NA) %>% coluna_numerica(),
    nlr = coluna_na_numerica(nlr, "#DIV/0!", NA) %>% coluna_numerica(),
    ldl_dosado = coluna_na_numerica(ldl_dosado, "#DIV/0!", NA) %>% coluna_numerica(),
    vldl = coluna_na_numerica(vldl, "#DIV/0!", NA) %>% coluna_numerica(),
    hba1c = coluna_numerica(hba1c),
    creatinina = coluna_numerica(creatinina),
    filtr_glomerular = coluna_na_numerica(filtr_glomerular, "#DIV/0!", NA) %>% coluna_numerica(),
    ck = coluna_numerica(ck)
    )

df1 <- df1 %>%
  mutate_at(vars(-c(iniciais, grupo, escolaridade, etnia, num_gestacoes)), as.numeric)
```

```{r tratamento_df2}
####  DF2: Dados Gestacionais

colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "Há quantos anos",
  "PESO BEBÊ (kg)",
  "PARTO                                     0:normal   1:cesariana   2:fórceps  3: induzido",
  "PARTO PREMATURO 0:não      1:sim"
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "quantos_anos_evento",
  "peso_bebe",
  "tipo_parto",
  "prematuro"
  )

df2 <- df2 %>% dplyr::select(all_of(colunas_interesse))
colnames(df2) <- renomear_colunas

grupos_nulos <- df2 %>% dplyr::select(grupo) %>% is.na()
df2 <- df2 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    quantos_anos_evento = quantos_anos_evento %>% as.numeric(),
    peso_bebe = coluna_numerica(peso_bebe),
    tipo_parto = as.factor(coluna_numerica(tipo_parto)),
    prematuro = as.factor(prematuro)
    )
```

```{r tratamento_df3}
#### DF3: ELISAs

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "PAI-1 (ng/mL)",
 "Log PAI-1 (ng/mL)",
 "TROMBOMODULINA (ng/mL)",
 "ADMA (ng/mL)",
 "sFlt1 (pg/mL)",
 "Absorbâncias sFlt1",
 "sFlt1 (pg/mL) Ajuste linear (Luiza)",
 "AA-AT1 (ng/mL)"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "pai1",
 "logpai1",
 "trombomodulina",
 "adma",
 "sflt1",
 "absor_sflt1",
 "sflt1_ajuste",  
 "aaat1"
)
df3 <- df3 %>% dplyr::select(all_of(colunas_interesse))
colnames(df3) <- renomear_colunas

df3 <- df3 %>% drop_na(grupo) %>% 
  mutate(
  pai1 = coluna_numerica(pai1),
  logpai1 = coluna_numerica(logpai1),
  trombomodulina = coluna_numerica(trombomodulina),
  adma = coluna_numerica(adma), 
  sflt1 = coluna_na_numerica(sflt1, "< curva", NA) %>% coluna_numerica(),
  absor_sflt1 = coluna_numerica(absor_sflt1),
  sflt1_ajuste = coluna_numerica(sflt1_ajuste),
  aaat1 = coluna_numerica(aaat1)
)

df3 <- df3 %>%
  mutate_at(vars(-iniciais), as.numeric)

# corrigindo outro erro de adma
df3$adma <- df3$adma %>% ifelse(. == 999999, NA, .) %>% as.numeric()
```

```{r tratamento_df4}
#### DF4: Imunoturbidimetria

colunas_interesse <- c(
   "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "DÍMERO-D (ng/mL)",
 "LOG DÍMERO-D"
)
renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "dimero",
 "logdimero"
)
df4 <- df4 %>% dplyr::select(all_of(colunas_interesse))
colnames(df4) <- renomear_colunas

df4 <- df4 %>% 
  mutate_at(vars(-iniciais), as.numeric)

# alterando df4
df4 <- df4 %>% mutate(
    dimero = coluna_numerica(dimero)
)
```

```{r tratamento_df5}
#### DF5: Doenças Crônicas

colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "HIPERTENSÃO 0:não   1:sim",
 "DIABETES 0:não   1:sim",
 "HIPERCOLESTEROLEMIA 0:não   1:sim",
 "FIBROMIALGIA 0:não   1:sim",
 "GLAUCOMA 0:não   1:sim",
 "ENXAQUECA 0:não   1:sim",
 "HIPOTIREOIDISMO 0:não   1:sim",
 "ASMA 0:não   1:sim",
 "ESTEATOSE HEPÁTICA 0:não   1:sim",
 "SÍNDROME DO INTESTINO IRRITÁVEL 0:não   1:sim",
 "HEMANGIOMA  0:não   1:sim",
 "TROMBOFILIA  0:não   1:sim",
 "BRONQUITE  0:não   1:sim",
 "RINITE  0:não   1:sim",
 "OVÁRIOS POLICÍSTICOS 0:não   1:sim",
  "Transtorno de ansiedade generalizada (TAG)  0:não   1:sim",
 "SINUSITE 0:não 1:sim",
 "DEPRESSÃO 0:não   1:sim",
 "ARTROSE 0:não   1:sim",
 "LEUCOCITOSE 0:não   1:sim",
 "ANEMIA 0:não   1:sim",
 "SÍNDROME DO PÂNICO 0:não   1:sim",
 "GASTRITE 0:não   1:sim",
 "HEPATITE 0:não   1:sim",
 "CRISE ALÉRGICA 0:não   1:sim",
 "CISTITE 0:não   1:sim",
 "ANEMIA FALCIFORME 0: não 1:sim",
 "MIOMA UTERINO 0: não 1: sim",
 "CÁLCULO RENAL 0: não 1: sim",
 "CALCIFICAÇÃO MAMÁRIA 0: não 1: sim",
 "HIPOGLICEMIA 0: não 1: sim",
 "DERRAME DE VISTA 0: não 1: sim",
 "HIDRADENITE 0: não 1: sim",
 "GLOMERULOESCLEREOSE  0: não 1: sim",
 "PRÉ-DIABETES 0: não 1: sim",
  "BIPOLAR 0: não 1: sim",
  "TDAH 0: não 1: sim",
  "TEA 0: não 1: sim",
  "DOENÇA DE STILL 0: não 1: sim"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "hipertensao",
 "diabetes",
 "hipercolesterolemia",
 "fibromialgia",
 "glaucoma",
 "enxaqueca",
 "hipotireoidismo",
 "asma",
 "esteatose_hepatica",
 "sindrome_intestino_irritavel",
 "hemangioma",
 "trombofilia",
 "bronquite",
 "rinite",
 "ovario_policistico",
 "TAG",
 "sinusite",
 "depressao",
 "artrose",
 "leucocitose",
 "anemia",
 "sindrome_panico",
 "gastrite",
 "hepatite",
 "crise_alergica",
 "cistite",
 "anemia_falciforme",
 "mioma_uterino",
 "calculo_renal",
 "calcificacao_mamaria",
 "hipoglicemia",
 "derrame de vista",
 "hidradenite",
 "glomeruloesclerose",
 "pre_diabetes",
 "bipolaridade",
 "TDAH",
 "TEA",
 "Doenca_Still"
)

df5 <- df5 %>% dplyr::select(all_of(colunas_interesse))
colnames(df5) <- renomear_colunas

df5 <- df5 %>% 
  mutate_at(vars(-iniciais), as.numeric)
```

```{r funcoes_aplicadas_descritivas}
# Funcoes de gráficos numericos e categoricos
graficos <- function(dados, grupo, variavel, texto = "variável"){
  
  dados <- dados %>% 
    mutate(grupo = ifelse(grupo == "0", "Grupo MN", "Grupo MP"))
  
  tab <- dados %>% 
    group_by(grupo) %>% 
    summarise(
      `Média` = mean( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Des. Padrão`= sd( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Nulos` = is.na( !!sym(variavel) ) %>% sum() %>% round(2),
      `Quant.` = n() %>% round()) %>% 
    t()
  
  tabela <- data.frame(
    "Métrica" = row.names(tab)[2:5], 
    "MN" = as.numeric(tab[c(-1),1]),
    "MP" = as.numeric(tab[c(-1),2])) %>% 
    as_tibble()
  
  dados <- dados %>% filter(! is.na(variavel) )
  
  g1 <- dados %>%
    ggplot(aes(x = !!sym(grupo), y = !!sym(variavel), fill = !!sym(grupo))) + 
    geom_boxplot() + 
    labs(title = "Descritivas\n", x = "Grupos", y = str_to_upper(variavel), fill = "Grupos") +
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa))

  g2 <- dados %>% 
    ggplot(aes(x = !!sym(variavel))) +
    geom_histogram(fill = cor_verde) + 
    labs(y = "Frequência", x = str_to_upper(variavel))
  
  return(
    (g1 + gridExtra::tableGrob(tabela, rows = c("", "","", "")))/ 
      (g2)
  )
  }

# Funcao para gráficos categóricos
graficos_categoricos <- function(lista1, lista2, variavel){
  
  tabela <- prop.table(
    table(lista1, lista2), 
    margin = 2) #freq da escolaridade dentro dos grupos, ex: freq do grupo 2 no grupo 1
  
  perc <- data.frame(tabela) %>% 
    mutate(lista1 = ifelse(lista1 == "0", "Grupo MN", "Grupo MP")) %>% 
    rename(`Frequência` = Freq)
  
  g1 <- perc %>% 
    ggplot(aes(x = lista2, y = `Frequência` , fill = lista1)) +
    geom_bar(stat='identity') + 
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa)) +
    labs(
      x = str_to_title(variavel), 
      title = paste("Frequência de", variavel," por grupo"),
      fill = "Grupo") 
  
  return(g1)
}

# funcao Teste de Hipóteses
permutacoes <- function(grupo_MN, grupo_MP, n = 10000){
  difobs <- mean(grupo_MN, na.rm = T) - mean(grupo_MP, na.rm = T)
  dif <-numeric(n)
  todos <- c(grupo_MN, grupo_MP)
  todos <- todos[! is.na(todos)]
  set.seed(2023)
  N <- length(todos)

  for (i in 1:n) {
    # permutar dados
    sorteio <- sample(todos, replace = F)
  
    g1_perm <- sorteio[1:(N/2)]
    g2_perm <- sorteio[((N/2)+1):N]
    dif[i] <- mean(g1_perm)-mean(g2_perm)
  }
  valorp<- 2 * length(dif[dif > abs(difobs) ])/n # cauda superior
  alpha <- 0.05
  
  tipo_teste <- "Teste permutação"
  
  #cat(paste("Teste permutação\n",
  #          "Hipotese Alternativa: Medias diferentes para os grupos\n",
  #          paste0("Nivel de significancia de ", alpha),
  #          "pvalor =", valorp), 
  #    "\n", if_else(valorp >= alpha, "Não rejeita-se H0", "Rejeita-se H0"))
  
  return(list(method = tipo_teste, p.value = valorp))
  } 

realizar_teste <- function(dataframe, variavel) {
  
  dataframefiltrado <- dataframe %>%
    mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 

  grupo_MN<- dataframefiltrado %>%
    filter(grupo == "MN") %>%
    pull(variavel)
  
  grupo_MP<- dataframefiltrado %>%
    filter(grupo == "MP") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_MN)
  shapiro2 <- shapiro.test(grupo_MP)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_MN, grupo_MP)
  } else {
    resultado_teste <- t.test(grupo_MN, grupo_MP, alternative = "two.sided") 
    return(resultado_teste)
  }
}

# Teste de hipóteses para dados categóricos
hipo_categorica <- function(dados, grupo, variavel){
  data_grupo <- dados %>% dplyr::select( !!sym(grupo) ) %>% pull( !!sym(grupo) )
  data_variavel <- dados %>% dplyr::select( !!sym(variavel) ) %>% pull( !!sym(variavel) )
  tab = xtabs(~ data_grupo + data_variavel) # tabela de frequencia
  return(fisher.test(tab))
}

# Função para tratar dados extremos nos testes de hipóteses
retira_extremos <- function(dados_originais, coluna, ponto_corte){
  # remocao
  resumo <- dados_originais %>% dplyr::select(coluna) %>% pull(coluna)
  n_corte <- resumo[resumo > ponto_corte] %>% length()
  df_filtro <- dados_originais %>% filter( !!sym(coluna) < ponto_corte)
  return(df_filtro)
}

# Funcao para resumir retiradas de extremos
descritiva_extremos <- function(dados_originais, dados_filtro , coluna){
  
  # Antes remocao  
  tab_antes <- dados_originais %>% 
    summarise(
      `Média` = mean( !!sym(coluna) , na.rm = TRUE) %>% round(2),
      `Des. Padrão`= sd( !!sym(coluna) , na.rm = TRUE) %>% round(2),
      `Nulos` = is.na( !!sym(coluna) ) %>% sum() %>% round(2),
      `Quant.` = n() %>% round()) %>% 
    t()
  
  # Apos remocao  
  tab_apos <- dados_filtro %>% 
    summarise(
      `Media` = mean( !!sym(coluna) , na.rm = TRUE) %>% round(2),
      `DP`= sd( !!sym(coluna) , na.rm = TRUE) %>% round(2),
      `Nulos` = is.na( !!sym(coluna) ) %>% sum() %>% round(2),
      `Quant.` = n() %>% round()) %>% 
    t()
  
  tabela <- data.frame(
    "Métrica" = row.names(tab_antes), 
    `Antes da retirada` = as.numeric(tab_antes),
    `Após a retirada` = as.numeric(tab_apos)) %>% 
    as_tibble()
  
  return(
    tabela %>% kable(caption = "Resumo da retirada") %>% 
      footnote(paste0("Variável de referência: ", coluna))
    )%>% 
  kable_styling("striped", full_width = F)
}


# Funcao tabela resumo de frequencia
funcao_tabela <- function(dados, grupo, variavel){
  return(
    dados %>% 
    tabyl( !!sym(grupo), !!sym(variavel), show_na = F) %>% 
    adorn_percentages() %>% 
    adorn_rounding(4) %>%  adorn_pct_formatting(digits = 2) %>% 
      kable(caption = "Tabela da proporção da variavel por grupo")%>% 
  kable_styling("striped", full_width = F)
  )
}
```

```{r descritivas_por_variavel}
### Idade:
variavel <- "idade"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado

### Etnia:
variavel <- "etnia"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado

### Escolaridade:
variavel <- "escolaridade"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Há quantos anos foi a gestação de interesse :
variavel = "num_gestacoes"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Peso da mulher:
variavel = "peso"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### IMC:
variavel = "imc"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Percentual de gordura:
variavel = "gordura"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Pressão Sistólica:
variavel = "pressao_sis"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Pressão Diastólica:
variavel = "pressao_dias"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Pressão arterial média:
variavel = "pressao_media"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Circunferência de cintura:
variavel = "cintura"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Circunferência de abdômen:
variavel = "abdomen"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Circunferência de quadril:
variavel = "quadril"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Relação cintura vs quadril:
variavel = "cintura_quadril"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Neutrófilos:
variavel = "neu"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Linfócitos:
variavel = "lym"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Razão neutrófilo/linfócito NLR:
variavel = "nlr"

df_filtro <- retira_extremos(df1, variavel, 4)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Colesterol Total:
variavel = "colesterol_total"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### HDL:
variavel = "hdl"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### LDL dosado:
variavel = "ldl_dosado"
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### VLDL:
variavel = "vldl"

df_filtro <- retira_extremos(df1, variavel, 45)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Não-HDL:
variavel = "nao_hdl"

teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Triglicérides:
variavel = "triglicerides"

df_filtro <- retira_extremos(df1, variavel, 300)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Hemoglobina glicada HbA1c:
variavel = "hba1c"

df_filtro <- retira_extremos(df1, variavel, 6)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Creatinina:
variavel = "creatinina"

df_filtro <- retira_extremos(df1, variavel, 2)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Ritmo de filtração glomerular:
variavel = "filtr_glomerular"

df_filtro <- retira_extremos(df1, variavel, 400)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### TGP/ALT:
variavel = "tgp_alt"

teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### TGO/AST:
variavel = "tgo_ast"

teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Ácido úrico:
variavel = "acido_urico"

df_filtro <- retira_extremos(df1, variavel, 8)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Gama GT:
variavel = "gama_gt"

df_filtro <- retira_extremos(df1, variavel, 50)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Há quantos anos foi a gestação de interesse
variavel = "quantos_anos_evento"

tab = xtabs(~ df2$grupo + df2$quantos_anos_evento) # tabela de frequencia
teste <- fisher.test(tab, simulate.p.value = T)
teste$method <- "Fisher's Exact Test for Count Data simulated"

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Peso do bebê:
variavel = "peso_bebe"

teste <- realizar_teste(df2, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Tipo Parto
df2_filtro <- df2 %>% 
  filter(tipo_parto != "<NA>")

variavel = "tipo_parto"
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Prematuro
df2_filtro <- df2 %>% 
  filter(prematuro != "<NA>")

variavel = "prematuro"
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### PAI-1 ng/mL:
variavel = "pai1"

teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Trombomodulina ng/mL:
variavel = "trombomodulina"
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### ADMA ng/mL:
variavel = "adma"

df_filtro <- retira_extremos(df3, variavel, 250)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### AA-AT1 ng/mL:
variavel = "aaat1"
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Sflt1 sem previsões
variavel = "sflt1"

df_filtro <- retira_extremos(df3, variavel, 200)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Sflt1 com previsões feitas pelo ajuste da curva
df_est = results %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_geral = ifelse(is.na(sflt1), concentration.est, sflt1))

variavel = "sflt1_geral"

df_filtro <- retira_extremos(df3, variavel, 200)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Sflt1 com previsões feitas pelo método da Luiza
df_est = resultado_luiza %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_luiza = ifelse(is.na(sflt1), `Ajuste Luiza`, sflt1))

variavel = "sflt1_luiza"

df_filtro <- retira_extremos(df3, variavel, 200)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Dímero-D ng/mL:
variavel = "dimero"

df_filtro <- retira_extremos(df4, variavel, 1000)

teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Hipertensão
variavel = "hipertensao"
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Anti-hipertensivo
variavel = "anti_hiper"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Diabetes
variavel = "diabetes"
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Medicamento para diabetes
variavel = "medic_diabetes"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Hipercolesterolemia
variavel = "hipercolesterolemia"
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Medicamento para hipercolesterolemia
variavel = "medic_hipercol"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)

### Fumantes
variavel = "tabagista"
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
```

## Resumo testes de hipóteses

Para os dados numéricos, os testes tiveram por hipótese geral:

```{=tex}
\begin{eqnarray}
        {
        \left\{\begin{array}{lcc}
        H_{0}: {\mu_{Grupo~MN} = \mu_{Grupo~MP}} \\
        H_{1}: {\mu_{Grupo~MN} \neq \mu_{Grupo~MP}}
        \end{array}\right.
        }    \nonumber
    \end{eqnarray}
```
Caso os dados atendessem a suposição de normalidade para os grupos, foi aplicado o *Teste T* para comparação da média de dois grupos. Caso contrário, o *Teste de Permutação* foi aplicado como teste não paramétrico. Em suma, deseja-se avaliar se a média entre os grupos é igual para uma dada variável ou se há diferença.

Para as variáveis qualitativas, o *Teste Exato de Fisher* para tabelas de contingência $2~\cdot~m$ foi aplicado sobre a hipótese nula de que a proporção das categorias fossem iguais para ambos grupos (*MN* e *MP*).

Há apenas 2 observações no *grupo MN* da variável **CK** (*Tabela 6*), logo, não foi possível realizar o teste de médias para ele.

```{r}
### CK:
variavel = "ck"

df1 %>%
  mutate(Grupo = ifelse(grupo == "0", "MN", "MP")) %>%
  group_by(grupo) %>% 
  summarise(
    Nulos = sum(is.na(ck)),
    `Nao nulos` = sum(!is.na(ck))
    ) %>% kable(caption = "Quantidade de nulos e não nulos por grupo de CK")%>% 
  kable_styling("striped", full_width = F)
```

Em seguida,na *Tabela 7*, será apresentado o resumo de todos testes de hipóteses aplicados as variáveis.

```{r}
tabela_resumo_ordenada <- tabela_resumo %>% arrange(Pvalor) 

tabela_resumo_ordenada %>% 
  kable(caption = "Resumo de todos os resultados dos testes")%>% 
  kable_styling("striped", full_width = F)
```

Resumo Descritivas favoráveis para o estudo sobre as variáveis que impactam na média ou frequência dentro do grupo *Grupo MN* e *Grupo MP* para um nível de significância de $\alpha = 0,05$ está contido na *Tabela 8*.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.05) %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 0.05 de significância")%>% 
  kable_styling("striped", full_width = F)
```

A *Tabela 9* indica as as seguintes variáveis seriam candidatas a impactar no grupo, caso fosse assumido um nível de significância de $\alpha = 0,10$.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.1) %>% 
  mutate("Conclusão" = "Significativo") %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 0.1 de significância")%>% 
  kable_styling("striped", full_width = F)
```

## Regressão Logística

```{r include=FALSE}
library(tidyverse)
library(car)

## adicionando "2" nos nomes que são repetidos

posicoes_duplicadas <- which(duplicated(df1$iniciais))
df1$iniciais[posicoes_duplicadas] <- paste0(df1$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df3$iniciais))
df3$iniciais[posicoes_duplicadas] <- paste0(df3$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df4$iniciais))
df4$iniciais[posicoes_duplicadas] <- paste0(df4$iniciais[posicoes_duplicadas], "2")

## juntando data frames
dfmodelo <- df1 %>%
  left_join(df3, by = "iniciais") %>%
  left_join(df4, by = "iniciais")

## data frame só com as variáveis que eu vou precisar
dfmodelo<- cbind(dfmodelo$iniciais, dfmodelo$pressao_sis, dfmodelo$pressao_dias, dfmodelo$grupo.x, dfmodelo$idade, dfmodelo$tabagista, dfmodelo$imc, dfmodelo$gordura, dfmodelo$cintura, dfmodelo$quadril, dfmodelo$cintura_quadril, dfmodelo$colesterol_total, dfmodelo$hdl, dfmodelo$ldl_dosado, dfmodelo$triglicerides, dfmodelo$hba1c, dfmodelo$pai1, dfmodelo$aaat1, dfmodelo$dimero) %>% as.data.frame() 

# nome pras colunas do df regressao
colnames(dfmodelo) <- c("iniciais", "pressao_sis", "pressao_dias", "grupo", "idade", "tabagista", "imc", "gordura", "cintura", "quadril", "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides", "hba1c", "pai1", "aaat1", "dimero")

# variaveis para numerico
var_cat <- c("iniciais", "grupo")
dfmodelo <- dfmodelo %>% mutate_at(vars(-var_cat), as.numeric)

# criando coluna para a variavel resposta: pressao alta
dfmodelo$alta_pressao <- ifelse(dfmodelo$pressao_sis > 140 | dfmodelo$pressao_dias > 90, 1, 0)

## colocando em ordem crescente a quantidade de na presentes em cada coluna
comna<- sort(colMeans(is.na(dfmodelo)))

# não utilizaremos tirar dimero, pai1, aaat1, hba1c, que tem mais de de 20% de NA cada um
colunas_para_descartar <- c("dimero", "pai1", "hba1c", "aaat1")

# Use a função select() do dplyr para manter todas as colunas, exceto as listadas
dfmodelo <- dfmodelo %>%
  dplyr::select(-any_of(colunas_para_descartar)) %>%
  na.omit()
```

```{r include=FALSE}
permutacoes <- function(grupo_MN, grupo_MP, n = 10000){
  difobs <- mean(grupo_MN, na.rm = T) - mean(grupo_MP, na.rm = T)
  dif <-numeric(n)
  todos <- c(grupo_MN, grupo_MP)
  todos <- todos[! is.na(todos)]
  set.seed(2023)
  N <- length(todos)

  for (i in 1:n) {
    # permutar dados
    sorteio <- sample(todos, replace = F)
  
    g1_perm <- sorteio[1:(N/2)]
    g2_perm <- sorteio[((N/2)+1):N]
    dif[i] <- mean(g1_perm)-mean(g2_perm)
  }
  valorp<- 2 * length(dif[dif > abs(difobs) ])/n # cauda superior
  alpha <- 0.05
  
  tipo_teste <- "Teste permutação"
  
  #cat(paste("Teste permutação\n",
  #          "Hipotese Alternativa: Medias diferentes para os grupos\n",
  #          paste0("Nivel de significancia de ", alpha),
  #          "pvalor =", valorp), 
  #    "\n", if_else(valorp >= alpha, "Não rejeita-se H0", "Rejeita-se H0"))
  
  return(list(method = tipo_teste, p.value = valorp))
  } 

resumo_testes <- function(teste, variavel){
    pvalor <- teste$p.value
    metodo <- teste$method  
    alpha <- 0.05
    conclusao <- if_else(pvalor >= alpha, "Não rejeita-se H0", "Rejeita-se H0")
    
    lista <- list(
      Nome = variavel,
      `Método` = metodo,
      Pvalor = pvalor %>% round(4),
      `Conclusão` = conclusao)
    
    return(lista %>% as_tibble() )
}

realizar_teste2 <- function(dataframe, variavel) {

  grupo_1<- dataframe %>%
    filter(alta_pressao == "0") %>%
    pull(variavel)
  
  grupo_2<- dataframe %>%
    filter(alta_pressao == "1") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_1)
  shapiro2 <- shapiro.test(grupo_2)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_1, grupo_2)
  } else {
    resultado_teste <- t.test(grupo_1, grupo_2, alternative = "two.sided") 
    return(resultado_teste)
  }
}


col_teste_num <- c("pressao_sis", "pressao_dias","idade", "imc", "gordura", "cintura", "quadril",
               "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides")


tabela_resumo <-  resumo_testes( realizar_teste2(dfmodelo, "pressao_sis"),"pressao_sis")

for (col in col_teste_num[-1]) {
    teste_hiper <- realizar_teste2(dfmodelo, col)
    resultado <- resumo_testes(teste_hiper, col)
    tabela_resumo <- rbind(tabela_resumo, resultado)
}

tabela_grupo <- table(dfmodelo$alta_pressao, dfmodelo$grupo)
teste_grupo <- chisq.test(tabela_grupo)

tabela_tabagista <- table(dfmodelo$alta_pressao, dfmodelo$tabagista)
teste_tabagista <- chisq.test(tabela_tabagista)

# Crie tabelas de resumo para os resultados dos testes Qui-Quadrado
resumo_grupo <- resumo_testes(teste_grupo, "grupo")
resumo_tabagista <- resumo_testes(teste_tabagista, "tabagista")

# Junte as tabelas de resumo dos testes Qui-Quadrado com a tabela de resumo existente
tabela_resumo <- bind_rows(tabela_resumo, resumo_grupo, resumo_tabagista)

# Exiba a tabela completa
tabela_resumo %>% arrange(Pvalor)

```


```{r}
library(hnp)
library(car)
library(lmtest)
library(DescTools)
library(nnet)
library(psych)
library(gtsummary)
pairs.panels(dfmodelo[4:12])
```

Na matriz de dispersão e correlação é possível identificar uma relação linear positiva entre as seguintes variáveis: IMC, gordura, cintura e quadril.

```{r include=FALSE}
modelo<- glm(alta_pressao ~ grupo + imc + cintura + cintura_quadril + idade + quadril + gordura + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo)
vif(modelo)

modelo1<- glm(alta_pressao ~ grupo + imc, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo1)
vif(modelo1)
exp(coef(modelo1))
exp(confint(modelo1))

modelo2<- glm(alta_pressao ~ grupo + imc + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo2)
vif(modelo2)
exp(coef(modelo2))
exp(confint(modelo2))

modelo3<- glm(alta_pressao ~ grupo + gordura, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo3)
vif(modelo3)
exp(coef(modelo3))
exp(confint(modelo3))

modelo4<- glm(alta_pressao ~ grupo + ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo4)
vif(modelo4)
exp(coef(modelo4))
exp(confint(modelo4))

vif(modelo1)
exp(coef(modelo1))
exp(confint(modelo1))

AIC(modelo1, modelo2, modelo3, modelo4)

modelo5<- glm(alta_pressao ~ ldl_dosado, data = dfmodelo, family = "binomial"(link = 'logit'))
summary(modelo5)
# modelo independente com apenas a variável LDL, obtendo um coeficiente estimado de 0,012527 e um valor-p de 0,005265. No entanto, optamos por manter LDL no modelo final devido à sua importância clínica.

anova(modelo2, modelo4, test = "Chisq")

step(modelo4, direction = "both")

#modelo4 será nosso modelo final
```

```{r}
tbl_regression(modelo1, exponentiate = TRUE)
```

**Razão de chances - modelo 1**

As duas variáveis são significativas para o modelo, e o valor 1 não pertence a nenhum dos intervalos.
Os hífens na linha do grupo 1 indicam que vamos comparar nosso grupo 2 (mulheres que tiveram pré-eclâmpsia) em relação a ele. A variável grupo é binária, então, nesse modelo, a mulher que está no grupo 2 tem um aumento de 151% nas chances de ser hipertensa, em relação a mulher que está no grupo 1 (mulheres que não tiveram pré-eclâmpsia). 
Podemos dizer que, para o aumento de uma unidade no IMC, esperamos ver um aumento de cerca de 10% nas chances da mulher ter hipertensão.

```{r}
tbl_regression(modelo2, exponentiate = TRUE)
```

**Razão de chances - modelo 2**

As variáveis grupo e IMC são significativas para o modelo. O valor 1 não pertence aos intervalos dessas variáveis.
Os hífens na linha do grupo 1 indicam que vamos comparar nosso grupo 2 (mulheres que tiveram pré-eclâmpsia) em relação a ele. A variável grupo é binária, então, nesse modelo, a mulher que está no grupo 2 tem um aumento de 114% nas chances de ser hipertensa, em relação a mulher que está no grupo 1 (mulheres que não tiveram pré-eclâmpsia). 
Podemos dizer que, para o aumento de uma unidade no IMC, esperamos ver um aumento de cerca de 10% nas chances da mulher ter hipertensão. Essas chances não mudaram em relação ao modelo anterior.
A variável LDL não é considerada significativa para o modelo. O valor 1 é o limite inferior do intervalo. Para o aumento de uma unidade no LDL, existe um aumento de apenas 1% nas chances da mulher ter hipertensão.

```{r}
tbl_regression(modelo3, exponentiate = TRUE)
```

**Razão de chances - modelo 3**

As duas variáveis são significativas para o modelo. O valor 1 não pertence aos intervalos dessas variáveis.
Os hífens na linha do grupo 1 indicam que vamos comparar nosso grupo 2 (mulheres que tiveram pré-eclâmpsia) em relação a ele. A variável grupo é binária, então, nesse modelo, a mulher que está no grupo 2 tem um aumento de 157% nas chances de ser hipertensa, em relação a mulher que está no grupo 1 (mulheres que não tiveram pré-eclâmpsia). 
Podemos dizer que, para o aumento de uma unidade na gordura, esperamos ver um aumento de cerca de 5% nas chances da mulher ter hipertensão.

```{r}
tbl_regression(modelo4, exponentiate = TRUE)
```

**Razão de chances - modelo 4**

Apenas a variável grupo é significativa para o modelo. O valor 1 não pertence ao intervalo do grupo, e é o limite inferior na variável LDL.
Os hífens na linha do grupo 1 indicam que vamos comparar nosso grupo 2 (mulheres que tiveram pré-eclâmpsia) em relação a ele. A variável grupo é binária, então, nesse modelo, a mulher que está no grupo 2 tem um aumento de 141% nas chances de ser hipertensa, em relação a mulher que está no grupo 1 (mulheres que não tiveram pré-eclâmpsia). 
A variável LDL não é considerada significativa para o modelo. Para o aumento de uma unidade no LDL, existe um aumento de apenas 1% nas chances da mulher ter hipertensão.

Na tabela a seguir, temos as probabilidades preditas da mulher ter hipertensão, para os grupos 1 e 2, com os seguintes IMCs: 25, 30, 35, 40 e 45.

```{r}
valores_imc <- c(25, 30, 35, 40, 45)

grupos <- c("1", "2")

dados <- expand.grid(grupo = grupos, imc = valores_imc) %>%
  mutate(probabilidade = predict(modelo1, newdata = ., type = "response")) %>%
  arrange(grupo)

tabelinha <- dados %>%
  kable("html") %>%
  kable_styling("striped", full_width = F) %>%
  column_spec(1, bold = TRUE) %>%
  column_spec(2, bold = TRUE) %>%
  column_spec(3, width = "100px")
tabelinha
```

É evidente que há um considerável aumento nas probabilidades de hipertensão ao fazer a transição do "grupo 1" para o "grupo 2". Essa tendência é firmemente corroborada pelos resultados apresentados em nossa tabela de Razão de Chances. Além disso, à medida que o Índice de Massa Corporal (IMC) cresce, observamos um progressivo aumento nas probabilidades de uma mulher ser diagnosticada com hipertensão. Isso destaca a marcante influência do IMC na previsão da probabilidade de hipertensão, enfatizando a importância de considerar cuidadosamente o peso corporal na avaliação do risco dessa condição de saúde.

# Apêndice

## Resíduos curva

```{r fig.cap="Gráfico dos valores ajustados pelos resíduos do modelo",out.width = "70%", fig.align='center'}
grafico_residuos
```

## Resíduos modelos de regressão

A função hnp (Half-Normal Plots with Simulation Envelopes/ Gráficos meio normais com envelopes de simulação), do pacote hnp, do Rstudio, tem como função produzir um gráfico (meio) normal de um objeto de modelo ajustado para uma variedade de modelos diferentes. O hpn serve como guia do que se esperar de um modelo bem ajustado.

Resíduos modelo 1

```{r warning=FALSE, message=FALSE}
#verificação
hnp(modelo1)
# Gráfico (semi) normal com envelope de simulação para diagnósticos comuns a partir de modelos ajustados
```

Resíduos modelo 2

```{r warning=FALSE, message=FALSE}
#verificação
hnp(modelo2)
# Gráfico (semi) normal com envelope de simulação para diagnósticos comuns a partir de modelos ajustados
```

Resíduos modelo 3

```{r warning=FALSE, message=FALSE}
#verificação
hnp(modelo3)
# Gráfico (semi) normal com envelope de simulação para diagnósticos comuns a partir de modelos ajustados
```

Resíduos modelo 4

```{r warning=FALSE, message=FALSE}
#verificação
hnp(modelo4)
# Gráfico (semi) normal com envelope de simulação para diagnósticos comuns a partir de modelos ajustados
```

Com base nos gráficos acima, observamos que a modelagem binomial se ajustou bem para modelar nossos dados, e apresentou um bom ajuste, englobando todos os pontos dentro do envelope.

## Idade:

```{r, fig.cap="Análise descritiva por grupo para a variável idade",out.width = "70%", fig.align='center'}
variavel <- "idade"
graficos(df1, "grupo", variavel)
```

## Etnia:

```{r, fig.cap="Análise descritiva por grupo para a variável etnia",out.width = "70%", fig.align='center'}
variavel <- "etnia"
graficos_categoricos(df1$grupo, df1$etnia, variavel)

# Tabela de percentual
df_tab1 <- df1 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab1 %>% 
  mutate(etnia = ifelse(etnia == 1, "Branca",
                        ifelse(etnia == 2, "Parda", "Negra")))

funcao_tabela(tab, "Grupo", "etnia")
```

## Escolaridade:

```{r, fig.cap="Análise descritiva por grupo para a variável escolaridade",out.width = "70%", fig.align='center'}
variavel <- "escolaridade"
graficos_categoricos(df1$grupo, df1$escolaridade, variavel)

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(escolaridade = ifelse(escolaridade == 0, "4ª série",
                               ifelse(escolaridade == 1, "Fundamental",
                                      ifelse(escolaridade == 2, "Ensino Médio", 
                                             ifelse(escolaridade == 3, "Ensino técnico",
                                                    ifelse(escolaridade == 4, "Superior",
                                                           "Pós-graduação"))))))

funcao_tabela(tab, "Grupo", "escolaridade")
```

## Há quantos anos foi a gestação de interesse :

```{r, fig.cap="Análise descritiva por grupo para a variável há quantos anos foi a gestação de interesse",out.width = "70%", fig.align='center'}
variavel = "num_gestacoes"
graficos_categoricos(df1$grupo, df1$num_gestacoes, "Há quantos anos foi a gestação de interesse")
```

## Peso da mulher:

```{r, fig.cap="Análise descritiva por grupo para a variável peso",out.width = "70%", fig.align='center'}
variavel = "peso"
graficos(df1, "grupo", variavel)
```

## IMC:

```{r, fig.cap="Análise descritiva por grupo para a variável IMC",out.width = "70%", fig.align='center'}
variavel = "imc"
graficos(df1, "grupo", variavel)
```

## Percentual de gordura:

```{r, fig.cap="Análise descritiva por grupo para a variável gordura",out.width = "70%", fig.align='center'}
variavel = "gordura"
graficos(df1, "grupo", variavel)
```

## Pressão Sistólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão sistólica",out.width = "70%", fig.align='center'}
variavel = "pressao_sis"
graficos(df1, "grupo", variavel)
```

## Pressão Diastólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão diastólica",out.width = "70%", fig.align='center'}
variavel = "pressao_dias"
graficos(df1, "grupo", variavel)
```

## Pressão arterial média:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão média",out.width = "70%", fig.align='center'}
variavel = "pressao_media"
graficos(df1, "grupo", variavel)
```

## Circunferência de cintura:

```{r, fig.cap="Análise descritiva por grupo para a variável cintura",out.width = "70%", fig.align='center'}
variavel = "cintura"
graficos(df1, "grupo", variavel)
```

## Circunferência de abdômen:

```{r, fig.cap="Análise descritiva por grupo para a variável circunferência do abdômen",out.width = "70%", fig.align='center'}
variavel = "abdomen"
graficos(df1, "grupo", variavel)
```

## Circunferência de quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável quadril",out.width = "70%", fig.align='center'}
variavel = "quadril"
graficos(df1, "grupo", variavel)
```

## Relação cintura vs quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável de relação da cintura vs quadril",out.width = "70%", fig.align='center'}
variavel = "cintura_quadril"
graficos(df1, "grupo", variavel)
```

## Neutrófilos:

```{r, fig.cap="Análise descritiva por grupo para a variável neutrófilos",out.width = "70%", fig.align='center'}
variavel = "neu"
graficos(df1, "grupo", variavel)
```

## Linfócitos:

```{r, fig.cap="Análise descritiva por grupo para a variável linfócitos",out.width = "70%", fig.align='center'}
variavel = "lym"
graficos(df1, "grupo", variavel)
```

## Razão neutrófilo/linfócito NLR:

```{r, , fig.cap="Análise descritiva por grupo para a variável NLR",out.width = "70%", fig.align='center'}
variavel = "nlr"

df_filtro <- retira_extremos(df1, variavel, 4)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Colesterol Total:

```{r, fig.cap="Análise descritiva por grupo para a variável colesterol total",out.width = "70%", fig.align='center'}
variavel = "colesterol_total"
graficos(df1, "grupo", variavel)
```

## HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável HDL",out.width = "70%", fig.align='center'}
variavel = "hdl"
graficos(df1, "grupo", variavel)
```

## LDL dosado:

```{r, fig.cap="Análise descritiva por grupo para a variável LDL dosado",out.width = "70%", fig.align='center'}
variavel = "ldl_dosado"
graficos(df1, "grupo", variavel)
```

## VLDL:

```{r, fig.cap="Análise descritiva por grupo para a variável VLDL",out.width = "70%", fig.align='center'}
variavel = "vldl"

df_filtro <- retira_extremos(df1, variavel, 45)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Não-HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável Não-HDL",out.width = "70%", fig.align='center'}
variavel = "nao_hdl"
graficos(df1, "grupo", variavel)
```

## Triglicérides:

```{r, fig.cap="Análise descritiva por grupo para a variável triglicérides",out.width = "70%", fig.align='center'}
variavel = "triglicerides"

df_filtro <- retira_extremos(df1, variavel, 300)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Hemoglobina glicada HbA1c:

```{r, fig.cap="Análise descritiva por grupo para a variável HbA1c",out.width = "70%", fig.align='center'}
variavel = "hba1c"

df_filtro <- retira_extremos(df1, variavel, 6)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Creatinina:

```{r, fig.cap="Análise descritiva por grupo para a variável creatinina",out.width = "70%", fig.align='center'}
variavel = "creatinina"

df_filtro <- retira_extremos(df1, variavel, 2)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Ritmo de filtração glomerular:

```{r, fig.cap="Análise descritiva por grupo para a variável filtração glomerular",out.width = "70%", fig.align='center'}
variavel = "filtr_glomerular"

df_filtro <- retira_extremos(df1, variavel, 400)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## TGP/ALT:

```{r, fig.cap="Análise descritiva por grupo para a variável TGP/ALT",out.width = "70%", fig.align='center'}
variavel = "tgp_alt"
graficos(df1, "grupo", variavel)
```

## TGO/AST:

```{r, fig.cap="Análise descritiva por grupo para a variável TGO/AST",out.width = "70%", fig.align='center'}
variavel = "tgo_ast"
graficos(df1, "grupo", variavel)
```

## Ácido úrico:

```{r, fig.cap="Análise descritiva por grupo para a variável ácido úrico",out.width = "70%", fig.align='center'}
variavel = "acido_urico"

df_filtro <- retira_extremos(df1, variavel, 8)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## CK:

```{r, fig.cap="Análise descritiva por grupo para a variável CK",out.width = "70%", fig.align='center'}
variavel = "ck"
graficos(df1, "grupo", variavel)
```

## Gama GT:

```{r, fig.cap="Análise descritiva por grupo para a variável Gama GT",out.width = "70%", fig.align='center'}
variavel = "gama_gt"

df_filtro <- retira_extremos(df1, variavel, 50)
descritiva_extremos(df1, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Há quantos anos foi a gestação de interesse

```{r, fig.cap="Análise descritiva por grupo para a variável quantos anos passou-se do evento",out.width = "70%", fig.align='center'}
variavel = "quantos_anos_evento"
graficos_categoricos(df2$grupo, 
                     df2$quantos_anos_evento, "quantos anos foi a gestação de interesse")
```

## Peso do bebê:

```{r, fig.cap="Análise descritiva por grupo para a variável peso do bebê",out.width = "70%", fig.align='center'}
variavel = "peso_bebe"
graficos(df2, "grupo", variavel) 
```

## Tipo Parto

```{r, fig.cap="Análise descritiva por grupo para a variável tipo de parto",out.width = "70%", fig.align='center'}
df2_filtro <- df2 %>% 
  filter(tipo_parto != "<NA>")

variavel = "tipo_parto"
graficos_categoricos(df2_filtro$grupo, df2_filtro$tipo_parto, "Tipo de parto") 

# Tabela de percentual
df_tab2 <- df2 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab2 %>% 
  mutate(tipo_parto = ifelse(tipo_parto == 0, "Normal",
                             ifelse(tipo_parto == 1, "Cesariana", 
                                    ifelse(tipo_parto == 2, "Fórceps", "Induzido"))))

funcao_tabela(tab, "Grupo", "tipo_parto")
```

## Prematuro

```{r, fig.cap="Análise descritiva por grupo para a variável prematuro",out.width = "70%", fig.align='center'}
df2_filtro <- df2 %>% 
  filter(prematuro != "<NA>")

variavel = "prematuro"
graficos_categoricos(df2_filtro$grupo, df2_filtro$prematuro, "prematuro") 

# Tabela de percentual
tab <- df_tab2 %>% 
  mutate(prematuro = ifelse(prematuro == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "prematuro")
```

## PAI-1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável PAI-1",out.width = "70%", fig.align='center'}
variavel = "pai1"
graficos(df3, "grupo", variavel) 
```

## Trombomodulina ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável trombomodulina",out.width = "70%", fig.align='center'}
variavel = "trombomodulina"
graficos(df3, "grupo", variavel) 
```

## ADMA ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável ADMA",out.width = "70%", fig.align='center'}
variavel = "adma"

df_filtro <- retira_extremos(df3, variavel, 250)
descritiva_extremos(df3, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## AA-AT1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável AA-AT1",out.width = "70%", fig.align='center'}
variavel = "aaat1"
graficos(df3, "grupo", variavel)
```

## Sflt1 sem previsões

```{r, fig.cap="Análise descritiva por grupo para a variável sflt1 sem previsões",out.width = "70%", fig.align='center'}
variavel = "sflt1"

df_filtro <- retira_extremos(df3, variavel, 200)
descritiva_extremos(df3, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Sflt1 com previsões feitas pelo ajuste da curva

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo ajuste da curva",out.width = "70%", fig.align='center'}
variavel = "sflt1_geral"

df_filtro <- retira_extremos(df3, variavel, 200)
descritiva_extremos(df3, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Sflt1 com previsões feitas pelo método da Luiza

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo método da Luiza",out.width = "70%", fig.align='center'}
variavel = "sflt1_luiza"

df_filtro <- retira_extremos(df3, variavel, 200)
descritiva_extremos(df3, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Dímero-D ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável dimero",out.width = "70%", fig.align='center'}
variavel = "dimero"

df_filtro <- retira_extremos(df4, variavel, 1000)
descritiva_extremos(df4, df_filtro, variavel)

graficos(df_filtro, "grupo", variavel)
```

## Hipertensão

```{r, fig.cap="Análise descritiva por grupo para a variável hipertensão",out.width = "70%", fig.align='center'}
variavel = "hipertensao"
graficos_categoricos(df5$grupo, df5$hipertensao, "Hipertensão")

# Tabela de percentual
df_tab5 <- df5 %>% 
  mutate(Grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab5 %>% 
  mutate(hipertensao = ifelse(hipertensao == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "hipertensao")
```

## Anti-hipertensivo

```{r, fig.cap="Análise descritiva por grupo para a variável anti-hipertensivo",out.width = "70%", fig.align='center'}
variavel = "anti_hiper"
graficos_categoricos(df1$grupo, df1$anti_hiper, "Anti-hipertensivo")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(anti_hiper = ifelse(anti_hiper == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "anti_hiper")
```

## Diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável diabetes",out.width = "70%", fig.align='center'}
variavel = "diabetes"
graficos_categoricos(df5$grupo, df5$diabetes, "Diabetes")

# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(diabetes = ifelse(diabetes == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "diabetes")
```

## Medicamento para diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para diabetes",out.width = "70%", fig.align='center'}
variavel = "medic_diabetes"
graficos_categoricos(df1$grupo, df1$medic_diabetes, "Medicamento para diabetes")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_diabetes = ifelse(medic_diabetes == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "medic_diabetes")
```

## Hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável hipercolesterolemia",out.width = "70%", fig.align='center'}
variavel = "hipercolesterolemia"
graficos_categoricos(df5$grupo, df5$hipercolesterolemia,"Hipercolesterolemia")

# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(hipercolesterolemia = ifelse(hipercolesterolemia == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "hipercolesterolemia")
```

## Medicamento para hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para hipercolesterolemia",out.width = "70%", fig.align='center'}
variavel = "medic_hipercol"
graficos_categoricos(df1$grupo, df1$medic_hipercol, 
                     "Medicamento para hipercolesterolemia")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_hipercol = ifelse(medic_hipercol == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "medic_hipercol")
```

## Fumantes

```{r, fig.cap="Análise descritiva por grupo para a variável fumantes",out.width = "70%", fig.align='center'}
variavel = "tabagista"
graficos_categoricos(df1$grupo, df1$tabagista, "Fumantes")

# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(tabagista = ifelse(tabagista == 0, "Não","Sim"))

funcao_tabela(tab, "Grupo", "tabagista")
```

# Conclusão

Na análise, avaliamos uma amostra razoável e identificamos que o erro com delta menor que 10 é aceitável, fornecendo confiança em nossos resultados. Além disso, através da estimação da concentração por imputação do limite inferior, obtivemos uma curva logística de quatro parâmetros, permitindo assim a obtenção de valores de sFlt, resultados anteriormente inacessíveis por serem muito baixos.

Nossos resultados destacam a importância das variáveis "grupo" e "IMC" na predição da hipertensão em mulheres. O "grupo", que indicava se a mulher teve ou não pré-eclampsia mostrou-se como um fator significativo que aumenta substancialmente a probabilidade de ocorrência dessa condição. Além disso, o aumento do Índice de Massa Corporal (IMC) também se correlacionou com um maior risco de pré-eclâmpsia, enfatizando a relevância do controle do peso como parte da estratégia de prevenção.
Essas conclusões reforçam a necessidade de considerar atentamente esses fatores ao avaliar o risco de hipertensão.

# Referências

<https://dl.acm.org/doi/pdf/10.1145/503506.503509>

<https://est.ufba.br/sites/est.ufba.br/files/kim/matd49-aula04-fisher.pdf>

<https://www.jstor.org/stable/2527460?seq=1>

<http://ndl.ethernet.edu.et/bitstream/123456789/15304/1/9103.pdf> 

<https://janalin.github.io/analyse-ELISA/results.html>

<https://cran.r-project.org/web/packages/drc/drc.pdf>

<https://nomato.files.wordpress.com/2015/03/curvas-de-dose-resposta-no-software-r.pdf>
