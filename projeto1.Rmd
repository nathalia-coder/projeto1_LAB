---
title: "Projeto I"
author: 
  - "Bárbara"
  - "Nathalia Gabriella Ferreira dos Santos"
date: "`r Sys.Date()`"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message=FALSE, 
  warning=FALSE
  )
```

# Pacotes

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(patchwork) # para parcionar os graficos
```

# Análises

## Saneamento de dados

### **Extraindo dados**

Colunas usadas: Dados Atuais, *Dados Gestacionais*, *ELISAs*, *Imunoturbidimetria*,*Doenças Crônicas*

```{r}
rm(list = ls()) # limpa enviroment

df1 <- read_xlsx("dados.xlsx", sheet = "Dados Atuais")
df2 <- read_xlsx("dados.xlsx", sheet = "Dados Gestacionais")
df3 <- read_xlsx("dados.xlsx", sheet = "ELISAs")
df4 <- read_xlsx("dados.xlsx", sheet = "Imunoturbidimetria")
df5 <- read_xlsx("dados.xlsx", sheet = "Doenças Crônicas")
```

-   DF1: Dados Atuais

```{r}
#df1 %>% colnames()
colunas_interesse <- c(
  "GRUPO      MN:0      MP:1", 
  "IDADE    anos",
  "ESCOLARIDADE COMPLETA  0: 4ª série completa   1:fundamental completo 2:médio completo 3:ensino técnico completo 4:superior completo 5:pós-graduação completa",
  "NÚMERO GESTAÇÕES",
  "Peso (kg)",
  "IMC",
  "GORDURA (%)",
  "PRESSÃO SISTÓLICA (mmHg)",
  "PRESSÃO DIASTÓLICA (mmHg)",
  "PRESSÃO ARTERIAL MÉDIA",
  "CINTURA (cm)",
  "ABDÔMEN (cm)",
  "QUADRIL (cm)",
  "RELAÇÃO CINTURA/QUADRIL",
  "NEU (10³/µL)",
  "LYM (10³/µL)",
  "NLR",
  "Colesterol total (mg/dL)",
  "HDL (mg/dL)",
  "LDL (mg/dL) DOSADO",
  "VLDL (mg/dL)",
  "Não-HDL (mg/dL)",
  "Triglicérides (mg/dL)",
  "HbA1c (%)",
  "Creatinina (mg/dL)",
  "Ritmo de filtrção glomerular calculado",
  "TGP/ALT",
  "TGO/AST",
  "Ácido Úrico",
  "CK",
  "Gama GT"
  )

renomear_colunas <- c(
  "grupo", 
  "idade",
  "escolaridade",
  "num_gestacoes",
  "peso",
  "imc",
  "gordura",  
  "pressao_sis",
  "pressao_dias",
  "pressao_media", 
  "cintura",
  "abdomen",
  "quadril",
  "cintura_quadril",
  "neu",
  "lym",
  "nlr",
  "colesterol_total",
  "hdl",
  "ldl_dosado",
  "vldl",
  "nao_hdl",
  "triglicerides",
  "hba1c",
  "creatinina",
  "filtr_glomerular",
  "tgp_alt",
  "tgo_ast",
  "acido_urico",
  "ck",
  "gama_gt"
  )


df1 <- df1 %>% dplyr::select(all_of(colunas_interesse))
colnames(df1) <- renomear_colunas
```

```{r}
coluna_na_numerica <- function(lista, caracter = ".", substituto = ""){
  lista %>% 
    str_replace(. , pattern = ",", replacement = ".") %>%
    str_replace_na(. , replacement = "") %>% 
    ifelse(. == caracter, substituto, .) %>% as.numeric()
}

coluna_numerica <- function(lista){
  lista %>% 
    ifelse(. == 99999, NA, .) %>% as.numeric()
}
```

```{r}
grupos_nulos <- df1 %>% select(grupo) %>% is.na()
df1 <- df1 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    escolaridade = as.factor(escolaridade),
    peso = coluna_numerica(idade),
    imc = coluna_na_numerica(imc, "#DIV/0!", NA) %>% coluna_numerica(),
    gordura = coluna_na_numerica(gordura) %>% coluna_numerica(),
    pressao_sis = coluna_numerica(pressao_sis),
    pressao_dias = coluna_numerica(pressao_dias),
    pressao_media = coluna_numerica(pressao_media),
    cintura = coluna_numerica(cintura),
    abdomen = coluna_numerica(abdomen),
    quadril = coluna_numerica(quadril),
    cintura_quadril = coluna_na_numerica(cintura_quadril, "#DIV/0!", NA) %>% coluna_numerica(),
    nlr = coluna_na_numerica(nlr, "#DIV/0!", NA) %>% coluna_numerica(),
    ldl_dosado = coluna_na_numerica(ldl_dosado, "#DIV/0!", NA) %>% coluna_numerica(),
    vldl = coluna_na_numerica(vldl, "#DIV/0!", NA) %>% coluna_numerica(),
    hba1c = coluna_numerica(hba1c),
    creatinina = coluna_numerica(creatinina),
    filtr_glomerular = coluna_na_numerica(filtr_glomerular, "#DIV/0!", NA) %>% coluna_numerica(),
    ck = coluna_numerica(ck)
    )
```

```{r}
df1 %>% summary()
```

-   DF2: Dados Gestacionais

```{r}
#df2 %>% colnames()
colunas_interesse <- c(
  "GRUPO      MN:0      MP:1",
  "Há quantos anos",
  "PESO BEBÊ (kg)",
  "PARTO                                     0:normal   1:cesariana   2:fórceps  3: induzido",
  "PARTO PREMATURO 0:não      1:sim"
  )

renomear_colunas <- c(
  "grupo",
  "quantos_anos_evento",
  "peso_bebe",
  "tipo_parto",
  "prematuro"
  )


df2 <- df2 %>% select(all_of(colunas_interesse))
colnames(df2) <- renomear_colunas
```

```{r}
grupos_nulos <- df2 %>% select(grupo) %>% is.na()
df2 <- df2 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    quantos_anos_evento = quantos_anos_evento %>% as.numeric(),
    peso_bebe = coluna_numerica(peso_bebe),
    tipo_parto = as.factor(coluna_numerica(tipo_parto)),
    prematuro = as.factor(prematuro)
    )
```

```{r}
df2 %>% summary()
```

# Descritivas e Testes de Médias

## Funções que serão aplicadas:

```{r}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```

* Funções de gráficos numéricos e categóricos

```{r message=FALSE, warning=FALSE}
graficos <- function(dados, grupo, variavel, texto = "variável"){
  
  dados <- dados %>% 
    mutate(grupo = ifelse(grupo == "0", "Controle", "Tratamento"))
  
  tabela <- dados %>%
    dplyr::summarise(
    `Média` = mean( !!sym(variavel) , na.rm = TRUE) %>% round(2),
    `Desvio Padrão`= sd( !!sym(variavel) , na.rm = TRUE) %>% round(2),
    `Valores nulos` = is.na( !!sym(variavel) ) %>% sum() %>% round(2),
    `Tamanho da amostra` = n() %>% round()
    ) %>%
    tidyr::pivot_longer(dplyr::everything(), names_to = "Variável", values_to = "Valores")
  
  dados <- dados %>% filter(! is.na(variavel) )
  
  g1 <- dados %>%
    ggplot(aes(x = !!sym(grupo), y = !!sym(variavel), fill = !!sym(grupo))) + 
    geom_boxplot() + 
    labs(title = "Descritivas\n", x = "Grupos", y = str_to_upper(variavel), fill = "Grupos") + 
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa))


  g2 <- dados %>% 
    ggplot(aes(x = !!sym(variavel))) +
    geom_histogram(fill = cor_verde) + 
    labs(y = "Frequência", x = str_to_upper(variavel))
  
  return(
    (g1 + gridExtra::tableGrob(tabela, rows = c("", "","", "")))/ 
      (g2)
  )
  }
```

* Função para gráficos categóricos

```{r}
graficos_categoricos <- function(lista1, lista2, variavel){
  
  tabela <- prop.table(
    table(lista1, lista2), 
    margin = 2) #freq da escolaridade dentro dos grupos, ex: freq do grupo 2 no grupo 1
  
  perc <- data.frame(tabela) %>% 
    mutate(lista1 = ifelse(lista1 == "0", "Controle", "Tratamento")) %>% 
    rename(`Frequência` = Freq)
  
  g1 <- perc %>% 
    ggplot(aes(x = lista2, y = `Frequência` , fill = lista1)) +
    geom_bar(stat='identity') + 
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa)) +
    labs(
      x = str_to_title(variavel), 
      title = paste("Frequência de", variavel," por grupo"),
      fill = "Grupo") 
  
  return(g1)
}
```

* Teste de Hipóteses

```{r}
permutacoes <- function(grupo_MN, grupo_MP, n = 10000){
  difobs <- mean(grupo_MN, na.rm = T) - mean(grupo_MP, na.rm = T)
  dif <-numeric(n)
  todos <- c(grupo_MN, grupo_MP)
  todos <- todos[! is.na(todos)]
  set.seed(2023)
  N <- length(todos)

  for (i in 1:n) {
    # permutar dados
    sorteio <- sample(todos, replace = F)
  
    g1_perm <- sorteio[1:(N/2)]
    g2_perm <- sorteio[((N/2)+1):N]
    dif[i] <- mean(g1_perm)-mean(g2_perm)
  }
  valorp<-length(dif[dif<difobs])/n
  alpha <- 0.05
  
  cat(paste("Teste permutação\n",
            "Hipotese Nula: Medias iguais para os grupos\n",
            paste0("Nivel de significancia de ", alpha),
            "pvalor =", valorp), 
      "\n", if_else(valorp >= alpha/2, "Não rejeita-se H0", "Rejeita-se H0"))
  } 
```


```{r}
realizar_teste <- function(dataframe, variavel) {
  
  dataframefiltrado <- dataframe %>%
    mutate(grupo = ifelse(grupo == "0", "MN", "MP"))

  grupo_MN<- dataframefiltrado %>%
    filter(grupo == "MN") %>%
    pull(variavel)
  
  grupo_MP<- dataframefiltrado %>%
    filter(grupo == "MP") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_MN)
  shapiro2 <- shapiro.test(grupo_MP)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_MN, grupo_MP)
  } else {
    resultado_teste <- t.test(grupo_MN, grupo_MP, alternative = "greater") 
    return(resultado_teste)
  }
}
#realizar_teste(df3,"logpai1")
```

## Análise por variável:

### Idade:

Não rejeita-se a hipótese nula de que as médias sejam iguais.

```{r}
graficos(df1, "grupo", "idade")
realizar_teste(df1, "idade")
```

### Escolaridade: ** Falta aplicar teste para frequência dos categporicos

```{r}
graficos_categoricos(df1$grupo, df1$escolaridade, "escolaridade")
```

### Número de Gestações:

```{r}
graficos_categoricos(df1$grupo, df1$num_gestacoes, "Número de Gestações")
```

### Peso:

Não rejeita-se a hipótese nula de que as médias sejam iguais.

```{r}
graficos(df1, "grupo", "peso")
realizar_teste(df1, "peso")
```

### IMC:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "imc")
realizar_teste(df1, "imc")


```

### Gordura:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "gordura")
realizar_teste(df1, "gordura")
```

### Pressão Sistólica:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "pressao_sis")
realizar_teste(df1, "pressao_sis")
```


### Pressão Diastólica:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "pressao_dias")
realizar_teste(df1, "pressao_dias")
```

### Pressão Média:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "pressao_media")
realizar_teste(df1, "pressao_media")
```

### Cintura:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "cintura")
realizar_teste(df1, "cintura")
```

### Abdomen:

Não rejeita-se a hipótese nula que não haja diferença nas médias dos grupos.

```{r}
graficos(df1, "grupo", "abdomen")
realizar_teste(df1, "abdomen")
```

### Quadril:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "quadril")
realizar_teste(df1, "quadril")
```

### Relação cintura vs quadril:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "cintura_quadril")
realizar_teste(df1, "cintura_quadril")
```

### neu:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "neu")
realizar_teste(df1, "neu")
```

### lym:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "lym")
realizar_teste(df1, "lym")
```

### nlr:

Foi encontrado uma observação outlier, ela será retirada. 

* Relação antes da retirada:
```{r}
df1$nlr %>% summary()
df1$nlr[df1$nlr > 6]
```

* Após retirada:

```{r}
df_nlr <- df1 %>% 
  filter(nlr < 6)

df_nlr$nlr %>% summary()
```

Não rejeita-se a hipótese nula.

```{r}
graficos(df_nlr, "grupo", "nlr")
realizar_teste(df_nlr, "nlr")
```

### colesterol Total:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "colesterol_total")
realizar_teste(df1, "colesterol_total")
```

### hdl:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "hdl")
realizar_teste(df1, "hdl")
```

### ldl_dosado:

Rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "ldl_dosado")
realizar_teste(df1, "ldl_dosado")
```

### vldl:

Foi encontrado observação outlier, elas serão retiradas. 

* Relação antes da retirada:
```{r}
df1$vldl %>% summary()
df1$vldl[df1$vldl > 45]
```

* Após retirada:

```{r}
df_vldl <- df1 %>% 
  filter(vldl < 45)

df_vldl$vldl %>% summary()
```

Não rejeita-se a hipótese nula.

```{r}
graficos(df_vldl, "grupo", "vldl")
realizar_teste(df_vldl, "vldl")
```

### nao_hdl:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "nao_hdl")
realizar_teste(df1, "nao_hdl")
```

### triglicerides:

Foi encontrado observação outlier, elas serão retiradas. 

* Relação antes da retirada:
```{r}
df1$triglicerides %>% summary()
df1$triglicerides[df1$triglicerides > 300]
```

* Após retirada:

```{r}
df_triglicerides <- df1 %>% 
  filter(triglicerides < 300)

df_triglicerides$triglicerides %>% summary()
```

Não rejeita-se a hipótese nula.

```{r}
graficos(df_triglicerides, "grupo", "triglicerides")
realizar_teste(df_triglicerides, "triglicerides")
```

### hba1c: **Aqui também encontramos influentes mas não tiramos

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "hba1c")
realizar_teste(df1, "hba1c")
```

### creatinina:

Foi encontrado observação outlier, elas serão retiradas. 

* Relação antes da retirada:
```{r}
df1$creatinina %>% summary()
df1$creatinina[df1$creatinina > 4]
```

* Após retirada:

```{r}
df_creatinina <- df1 %>% 
  filter(creatinina < 4)

df_creatinina$creatinina %>% summary()
```

Rejeita-se a hipótese nula.

```{r}
graficos(df_creatinina, "grupo", "creatinina")
realizar_teste(df_creatinina, "creatinina")
```

### filtr_glomerular:

Foi encontrado observação outlier, elas serão retiradas. 

* Relação antes da retirada:
```{r}
df1$filtr_glomerular %>% summary()
df1$filtr_glomerular[df1$filtr_glomerular > 3200]
```

* Após retirada:

```{r}
df_filtr_glomerular <- df1 %>% 
  filter(filtr_glomerular < 3200)

df_filtr_glomerular$filtr_glomerular %>% summary()
```

Não rejeita-se a hipótese nula.

```{r}
graficos(df_filtr_glomerular, "grupo", "filtr_glomerular")
realizar_teste(df_filtr_glomerular, "filtr_glomerular")
```

### tgp_alt:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "tgp_alt")
realizar_teste(df1, "tgp_alt")
```

### tgo_ast:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "tgo_ast")
realizar_teste(df1, "tgo_ast")
```

### acido_urico:

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "acido_urico")
realizar_teste(df1, "acido_urico")
```

### ck: ** Erro no teste

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "ck")

df_filtro <- df1 %>% 
  drop_na(ck)

#realizar_teste(df_filtro, "ck")
```

### gama_gt: ** Erro no teste

Não rejeita-se a hipótese nula.

```{r}
graficos(df1, "grupo", "gama_gt")
realizar_teste(df1, "gama_gt")
```

### quantos_anos_evento ** não sei se podemos aplicar esse teste

Não rejeita-se a hipótese nula.

```{r}
graficos_categoricos(df2$grupo, 
                     df2$quantos_anos_evento, 
                     "quantos anos se passou do evento")
realizar_teste(df2, "quantos_anos_evento")
```

### peso_bebe

Rejeita-se a hipótese nula.

```{r}
df2 %>% 
  drop_na(peso_bebe) %>% 
  graficos(., "grupo", "peso_bebe") 
realizar_teste(df2, "peso_bebe")
```

### peso_bebe ** Teste 

Rejeita-se a hipótese nula.

```{r}
df2_filtro <- df2 %>% 
  filter(tipo_parto != "<NA>")

graficos_categoricos(df2_filtro$grupo, df2_filtro$tipo_parto, "tipo de parto") 
```

### prematuro ** Testar isso

Rejeita-se a hipótese nula.

```{r}
df2_filtro <- df2 %>% 
  filter(prematuro != "<NA>")

graficos_categoricos(df2_filtro$grupo, df2_filtro$prematuro, "prematuro") 
```


```{r}
## testes
graficos(df1, "grupo", "imc")
graficos_categoricos(df1$grupo, df1$num_gestacoes, "número de gestações")
realizar_teste(df1, "idade")
```

## Resumo Descritivas

# Testes da curva

```{r}
#rm(list = ls()) # limpa enviroment
```

**Variável resposta: Concentração**

**Variável explicativa: Absorbância**

```{r}
newdata <- read_xlsx("curva.xlsx", sheet = "prev")
newdata %>% head()

ajuste <- read_xlsx("curva.xlsx", sheet = "ajust")

resultado <- newdata
resultado$ajust <- ajuste
resultado %>% head()
```

## Curva com base nos dados amostrais

* Modelo Logístico de 4 parâmetros

b = the Hill coefficient;a = min_value;d = max_value;c = EC50.

- Ideia foi achar coeficientes e depois aplicar inversa

- problema: função não está definida abaixo do valor mínimo

- Predict aqui prevê absorbância e não concentração

```{r}
library(drc)

data <- read_xlsx("curva.xlsx", sheet = "certo")
data %>% head()

data.m1 <- drm(abs ~ conc, data = data, 
                   fct = LL.4(names = c("Slope", "Lower Limit", "Upper Limit", "ED50")))

summary(data.m1)
confint(data.m1, level = 0.90) # tds sao sig

par(mfrow = c(1,1))
plot(data.m1, broken=F, xlab="Concentração", ylab="Absorbância", lwd=1.2, 
     cex=1.2, cex.axis=1.2, cex.lab=1.2)

# Extraindo coefs
coefs.data <- setNames(
  data.m1$coefficients,
  c("b", "a", "d", "c")
)
coefs.data

a = coefs.data[2]
b = coefs.data[1]
c = coefs.data[4]
d = coefs.data[3]

prev.x <- function(y){
  x <- c * ( (((a-d)/(y-d))-1)^(1/b) )
  return(x)
}

prev.x(.166)
prev.x(a+0.01)
```


## Curva com base teórica

```{r}
data2 <- read_xlsx("dados_teoricos.xlsx")

data.m2 <- drm(abs ~ conc, data = data2, 
               fct = LL.4(names = c("Slope", "Lower Limit", "Upper Limit", "ED50")))

summary(data.m2)
confint(data.m2, level = 0.90)

plot(data.m2, broken=F, xlab="Concentração", ylab="Absorbância", lwd=1.2, 
     cex=1.2, cex.axis=1.2, cex.lab=1.2)

# Extraindo coefs
coefs.data2 <- setNames(
  data.m2$coefficients,
  c("b", "a", "d", "c")
)
coefs.data2

a = coefs.data2[2]
b = coefs.data2[1]
c = coefs.data2[4]
d = coefs.data2[3]

prev.x <- function(y){
  x <- c * ( (((a-d)/(y-d))-1)^(1/b) )
  return(x)
}

prev.x(.166)
prev.x(a+0.01)
prev.x(0.048)
```

## Segundo pacote curva

```{r}
library(dr4pl)

## Exemplo pacote

# dados originais
a <- dr4pl(dose = sample_data_1$Dose,
             response = sample_data_1$Response,
             method.init = "logistic")
plot(a)

# dados ajuste
b <- dr4pl(formula = Response~Dose,
             data = sample_data_4,
             method.init = "Mead",
             method.robust = "Tukey" )
plot(b)

c <- dr4pl(data = sample_data_10,
             dose = Dose,
             response = Response)
plot(c)

c <- dr4pl(Response~Dose,
             data = drc_error_2,
             method.optim = "CG",
             trend = "decreasing" )
d <- plot(c, x.breaks = c(.00135, .0135, .135, 1.35, 13.5))
d + theme_grey()

## Como os dados se comportam

teste <- dr4pl(dose = data$conc,
             response = data$abs,
             method.init = "logistic")
plot(teste)

teste$parameters

teste2 <- dr4pl(formula = abs~conc,
             data = data,
             method.init = "Mead",
             method.robust = "Tukey" )
plot(teste2)

teste2$parameters
```

Modelo "teste" ficou melhor que o de teste2

```{r}
a = teste$parameters[4] # minimo
b = teste$parameters[3] # 
c = teste$parameters[2] # inflexao/mediana
d = teste$parameters[1] # maximo

prev.x <- function(y){
  x <- c * ( (((a-d)/(y-d))-1)^(1/b) )
  return(x)
}

prev.x(a+0.01)
prev.x(0.166)
```

## Nova estimação

Referência: https://janalin.github.io/analyse-ELISA/results.html

```{r}
library(minpack.lm)

data <- data %>% dplyr::mutate(log2concentration = log2(conc))
levm.fit <- nlsLM(
  abs ~
  Amin + ((Amax - Amin) / (1 + exp(n * (log2concentration - log2EC50)))),
  data = data,
  start = list(Amin = 0, Amax = 1, log2EC50 = 0.5, n = -1), # chutes iniciais
  control = list(maxiter = 500)
)
# Show summary of the fit
summary(levm.fit)
```

> Depois tentar pegar o mínimo ao invés da mediana

```{r}
# Set Amin to blank values
Amin <- min(newdata$abs) # mediana dos valores a serem previsto
# Re-fit with only three free parameters
levm.fit <- nlsLM(
  abs ~
  Amin + ((Amax - Amin) / (1 + exp(n * (log2concentration - log2EC50)))),
  data = data,
  start = list(Amax = 2, log2EC50 = 0.5, n = -1),
  control = list(maxiter = 500)
)
# Check new fit results
summary(levm.fit)
```

```{r}
drc.fit <- drm(abs ~ conc,
  data = data,
  fct = LL2.4(names = c("n", "Amin", "Amax", "EC50"))
)
summary(drc.fit)

plot(drc.fit)

# os residuos ficaram ruins
ggplot(as_tibble(drc.fit$predres)) +
  geom_point(aes(`Predicted values`, Residuals),
    pch = 1, size = 3, color = "cornflowerblue") +
  geom_hline(yintercept = 0, lwd = 0.2)
```

* Predizendo concentracao

```{r}

prev.conc = newdata$abs

n.est <- coef(drc.fit)[1]
#Amin <- coef(drc.fit)[2]
Amax.est <- coef(drc.fit)[3]
log2EC50.est <- log2(coef(drc.fit)[4])

log2concentration.est <- sapply(prev.conc, function(A){(1/n.est) * (log( ((Amax.est - A)/(A - Amin))) + log2EC50.est*n.est)})

# Get confidence intervals
n = nrow(data)

fgh <- deriv(
  log2concentration ~ (1/n) * (log( ((Amax - A)/(A - Amin))) + log2EC50*n),
  c("Amax", "log2EC50", "n"), function(Amax, log2EC50, n, A) {}
)
f.new <- fgh(Amax.est, log2EC50.est, n.est, data$abs)
g.new <- attr(f.new, "gradient")

drc.fit$predres

#gs <- rowSums((g.new %*% cov.fit) * g.new)
alpha <- 0.05
#delta.f <- sqrt(gs) * qt(1 - alpha/2, 15)
#results <- data %>% 
#  dplyr::mutate(concentration.est = 2^log2concentration.est) %>%
#  dplyr::mutate(log2concentration.est = log2concentration.est) %>%
#  dplyr::mutate(log2conf = delta.f) 

results <- newdata %>% 
  dplyr::mutate(concentration.est = 2^log2concentration.est)

results
```


# Tamanho Amostral

Foi repassado:

As variâncias para a pressão sistólica são:

Grupo MN: 196,90
Grupo MP: 514,95

Será considerado um $\alpha = 5%$ e $\beta = 10%$

```{r}
var1 <- 196.9
var2 <- 514.95
alpha <- 0.05
beta <- 0.1
gama <- 1

z2 <- qnorm(1 - alpha/2)
zbeta <- qnorm(1 - beta)

n = ((var1 + var2) * (z2 + zbeta)^2) / (gama^2) # falta o denominador
n %>% round()
```

