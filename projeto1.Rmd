---
title: "Projeto I"
author:
- Bárbara Oliveira Ribeiro
- Nathalia Gabriella Ferreira dos Santos
date: "`r Sys.Date()`"
output:
  pdf_document: default
  pdf_document2:
    number_sections: yes
    fig_caption: yes
header-includes: \usepackage[brazil]{babel}
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE, # true mostra o codigo
	message = FALSE,
	warning = FALSE
)
#options(OutDec = ",")
```

```{r pacotes, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(patchwork) # para parcionar os graficos
library(kableExtra)
```

```{r}
rm(list = ls())
```

# Introdução

# Objetivo

# Metodologia

# Tamanho Amostral

Foi repassado:

As variâncias para a **pressão sistólica** são:

* Grupo MN: 196,90

* Grupo MP: 514,95

Será considerado um nível de significância de $\alpha = 0,05$ e um poder de teste de $\beta = 0,10$.

```{r}
var1 <- 196.9
var2 <- 514.95
alpha <- 0.05
beta <- 0.1
delta <- c(0.1, 0.5, 1, 2, 5, 10) # erro

z2 <- qnorm(1 - alpha/2)
zbeta <- qnorm(1 - beta)

#se o erro aumenta, o n diminui. peq erros maior n
n = ((var1 + var2) * (z2 + zbeta)^2) / (delta^2) 

tibble(
  "Erro" = delta,
  "Tamanho Amostral" = n %>% round()
) %>% 
  kable(
    caption = "Cálculo do tamanho amostral para diferentes erros",
    format.args = list(big.mark = "."))
```


# Curva de concentração do Sflt1

```{r}
resultado <- read_xlsx("curva.xlsx", sheet = "prev") # valores a serem preditos
resultado_luiza <- read_xlsx("curva.xlsx", sheet = "ajust") %>% 
  rename("Ajuste Luiza" = ajust)
```

## Curva com base teórica

Modelo a ser usado para estimação dos parâmetros:

* Modelo Logístico de 4 parâmetros

**Variável resposta: Absorbância**

**Variável explicativa: Concentração**

Referência: https://janalin.github.io/analyse-ELISA/results.html

```{r}
library(drc)

data <- read_xlsx("dados_teoricos.xlsx")

new <- data.frame(
  conc = seq(0,50, 0.01)
)

# ajusta pelo metodo o LL2, no anterior era o LL. Esse eh o log2. dif minima entre ambos
drc.fit <- drm(abs ~ conc,
  data = data,
  fct = LL2.4( 
    names = c("Slope", "Amin", "Amax", "log2EC50")
    )
)

# Extraindo coefs
coefs.data <- setNames(
  drc.fit$coefficients %>% round(4),
  c("b", "a", "d", "c")
)
cbind(coefs.data)

summary(drc.fit)

plot(drc.fit, broken=F, xlab="Concentração", ylab="Absorbância", lwd=1.2, 
     cex=1.2, cex.axis=1.2, cex.lab=1.2)

ggplot(as_tibble(drc.fit$predres)) +
  geom_point(aes(`Predicted values`, Residuals),
     size = 3, color = "cornflowerblue") +
  geom_hline(yintercept = 0, lwd = 0.2) +
  labs(title = "Gráfico dos resíduos")
```

```{r}
abs_predita <- predict(object = drc.fit, new)
new$abs_inter <- abs_predita # prevista
#new %>% head() # ver se precisamos elevar os dados ao quadrado

novo_data <- new %>% dplyr::select(conc, abs_inter) %>% rename(abs = abs_inter)
novo_df <- rbind(data, novo_data)
#plot(log2(novo_df$conc), novo_df$abs)
plot(log2(new$conc), new$abs, type = "line")
```

## Estimação da concentração por imputação do limite inferior

Candidato a mínimo será o mínimo observado na amostra, demais serão os estimados.

```{r}
prev.conc = resultado$abs

slope.est <- coef(drc.fit)[1]
Amax.est <- coef(drc.fit)[3]
log2EC50.est <- coef(drc.fit)[4]
# Set Amin to blank values
Amin <- min(resultado$abs) # media dos valores a serem previsto

log2concentration.est <- sapply(
  prev.conc, function(A){(1/slope.est) * (log( ((Amax.est - A)/(A - Amin))) + log2EC50.est*slope.est)}
  )

results <- resultado %>% 
  dplyr::mutate(concentration.est = 2^log2concentration.est %>% round(3))

# resultados ja na escala desejada
left_join(results, resultado_luiza) %>% 
  arrange(abs) %>% 
  rename("Abssorbância" = abs, "Concentração Estimada" = concentration.est) %>% 
  kable(
    caption = "Comparativo das estimações para concentração de Sflt1 abaixo da curva"
    )
```

```{r}
novo_results <- results %>% rename(conc = concentration.est)

novo_df <- rbind(data, novo_results)
plot(log2(novo_df$conc), novo_df$abs)
plot(log2(new$conc), new$abs, type = "line")

novo_df <- rbind(data, novo_results, novo_data)
plot(log2(novo_df$conc), novo_df$abs)
plot(log2(new$conc), new$abs, type = "line")
```

```{r}
# tirando pacotes que podem dar conflito com o dplyr
detach("package:drc", unload = TRUE)
detach("package:MASS", unload = TRUE)
```

# Análises

## Tratamento de dados

### Extraindo dados

Colunas usadas: *Dados Atuais*, *Dados Gestacionais*, *ELISAs*, *Imunoturbidimetria*,*Doenças Crônicas*

```{r}
df1 <- read_xlsx("dados.xlsx", sheet = "Dados Atuais")
df2 <- read_xlsx("dados.xlsx", sheet = "Dados Gestacionais")
df3 <- read_xlsx("dados.xlsx", sheet = "ELISAs")
df4 <- read_xlsx("dados.xlsx", sheet = "Imunoturbidimetria")
df5 <- read_xlsx("dados.xlsx", sheet = "Doenças Crônicas")
```

**Funções para tratar os dados:**

```{r}
coluna_na_numerica <- function(lista, caracter = ".", substituto = ""){
  lista %>% 
    str_replace(. , pattern = ",", replacement = ".") %>%
    str_replace_na(. , replacement = "") %>% 
    ifelse(. == caracter, substituto, .) %>% as.numeric()
}

coluna_numerica <- function(lista){
  lista %>% 
    ifelse(. == 99999, NA, .) %>% as.numeric()
}
```

#### DF1: Dados Atuais

```{r}
colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "ETNIA                1:branca   2:parda   3:negra",
  "IDADE    anos",
  "ESCOLARIDADE COMPLETA  0: 4ª série completa   1:fundamental completo 2:médio completo 3:ensino técnico completo 4:superior completo 5:pós-graduação completa",
  "NÚMERO GESTAÇÕES",
  "Peso (kg)",
  "IMC",
  "GORDURA (%)",
  "PRESSÃO SISTÓLICA (mmHg)",
  "PRESSÃO DIASTÓLICA (mmHg)",
  "PRESSÃO ARTERIAL MÉDIA",
  "CINTURA (cm)",
  "ABDÔMEN (cm)",
  "QUADRIL (cm)",
  "RELAÇÃO CINTURA/QUADRIL",
  "NEU (10³/µL)",
  "LYM (10³/µL)",
  "NLR",
  "Colesterol total (mg/dL)",
  "HDL (mg/dL)",
  "LDL (mg/dL) DOSADO",
  "VLDL (mg/dL)",
  "Não-HDL (mg/dL)",
  "Triglicérides (mg/dL)",
  "HbA1c (%)",
  "Creatinina (mg/dL)",
  "Ritmo de filtrção glomerular calculado",
  "TGP/ALT",
  "TGO/AST",
  "Ácido Úrico",
  "CK",
  "Gama GT",
  "USA ANTI-HIPERTENSIVO 0:não 1:sim",
  "USA MEDICAMENTO PARA DIABETES 0:não 1:sim",
  "USA MEDICAMENTO PARA HIPERCOLESTEROLEMIA 0:não 1:sim",
  "TABAGISTA 0: não   1:sim" 
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "etnia",
  "idade",
  "escolaridade",
  "num_gestacoes",
  "peso",
  "imc",
  "gordura",  
  "pressao_sis",
  "pressao_dias",
  "pressao_media", 
  "cintura",
  "abdomen",
  "quadril",
  "cintura_quadril",
  "neu",
  "lym",
  "nlr",
  "colesterol_total",
  "hdl",
  "ldl_dosado",
  "vldl",
  "nao_hdl",
  "triglicerides",
  "hba1c",
  "creatinina",
  "filtr_glomerular",
  "tgp_alt",
  "tgo_ast",
  "acido_urico",
  "ck",
  "gama_gt",
  "anti_hiper",
  "medic_diabetes",
  "medic_hipercol",
  "tabagista"
  )


df1 <- df1 %>% dplyr::select(all_of(colunas_interesse))
colnames(df1) <- renomear_colunas

grupos_nulos <- df1 %>% select(grupo) %>% is.na()
df1 <- df1 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    etnia = coluna_numerica(etnia),
    escolaridade = as.factor(escolaridade),
    peso = coluna_numerica(peso),
    imc = coluna_na_numerica(imc, "#DIV/0!", NA) %>% coluna_numerica(),
    gordura = coluna_na_numerica(gordura) %>% coluna_numerica(),
    pressao_sis = coluna_numerica(pressao_sis),
    pressao_dias = coluna_numerica(pressao_dias),
    pressao_media = coluna_numerica(pressao_media),
    cintura = coluna_numerica(cintura),
    abdomen = coluna_numerica(abdomen),
    quadril = coluna_numerica(quadril),
    cintura_quadril = coluna_na_numerica(cintura_quadril, "#DIV/0!", NA) %>% coluna_numerica(),
    nlr = coluna_na_numerica(nlr, "#DIV/0!", NA) %>% coluna_numerica(),
    ldl_dosado = coluna_na_numerica(ldl_dosado, "#DIV/0!", NA) %>% coluna_numerica(),
    vldl = coluna_na_numerica(vldl, "#DIV/0!", NA) %>% coluna_numerica(),
    hba1c = coluna_numerica(hba1c),
    creatinina = coluna_numerica(creatinina),
    filtr_glomerular = coluna_na_numerica(filtr_glomerular, "#DIV/0!", NA) %>% coluna_numerica(),
    ck = coluna_numerica(ck)
    )

df1 <- df1 %>%
  mutate_at(vars(-c(iniciais, grupo, escolaridade, etnia, num_gestacoes)), as.numeric)
```

####  DF2: Dados Gestacionais

```{r}
colunas_interesse <- c(
  "NOME    (iniciais)",
  "GRUPO      MN:0      MP:1",
  "Há quantos anos",
  "PESO BEBÊ (kg)",
  "PARTO                                     0:normal   1:cesariana   2:fórceps  3: induzido",
  "PARTO PREMATURO 0:não      1:sim"
  )

renomear_colunas <- c(
  "iniciais",
  "grupo",
  "quantos_anos_evento",
  "peso_bebe",
  "tipo_parto",
  "prematuro"
  )


df2 <- df2 %>% select(all_of(colunas_interesse))
colnames(df2) <- renomear_colunas

grupos_nulos <- df2 %>% select(grupo) %>% is.na()
df2 <- df2 %>% 
  filter(! grupos_nulos) %>% 
  mutate(
    grupo = as.factor(grupo),
    quantos_anos_evento = quantos_anos_evento %>% as.numeric(),
    peso_bebe = coluna_numerica(peso_bebe),
    tipo_parto = as.factor(coluna_numerica(tipo_parto)),
    prematuro = as.factor(prematuro)
    )
```

#### DF3: ELISAs

```{r}
colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "PAI-1 (ng/mL)",
 "Log PAI-1 (ng/mL)",
 "TROMBOMODULINA (ng/mL)",
 "ADMA (ng/mL)",
 "sFlt1 (pg/mL)",
 "Absorbâncias sFlt1",
 "sFlt1 (pg/mL) Ajuste linear (Luiza)",
 "AA-AT1 (ng/mL)"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "pai1",
 "logpai1",
 "trombomodulina",
 "adma",
 "sflt1",
 "absor_sflt1",
 "sflt1_ajuste",  
 "aaat1"
)
df3 <- df3 %>% select(all_of(colunas_interesse))
colnames(df3) <- renomear_colunas

df3 <- df3 %>% drop_na(grupo) %>% 
  mutate(
  pai1 = coluna_numerica(pai1),
  logpai1 = coluna_numerica(logpai1),
  trombomodulina = coluna_numerica(trombomodulina),
  adma = coluna_numerica(adma), 
  sflt1 = coluna_na_numerica(sflt1, "< curva", NA) %>% coluna_numerica(),
  absor_sflt1 = coluna_numerica(absor_sflt1),
  sflt1_ajuste = coluna_numerica(sflt1_ajuste),
  aaat1 = coluna_numerica(aaat1)
)

df3 <- df3 %>%
  mutate_at(vars(-iniciais), as.numeric)

# corrigindo outro erro de adma
df3$adma <- df3$adma %>% ifelse(. == 999999, NA, .) %>% as.numeric()
```

#### DF4: Imunoturbidimetria

```{r}
colunas_interesse <- c(
   "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "DÍMERO-D (ng/mL)",
 "LOG DÍMERO-D"
)
renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "dimero",
 "logdimero"
)
df4 <- df4 %>% select(all_of(colunas_interesse))
colnames(df4) <- renomear_colunas

df4 <- df4 %>% 
  mutate_at(vars(-iniciais), as.numeric)

# alterando df4
df4 <- df4 %>% mutate(
    dimero = coluna_numerica(dimero)
)

```

#### DF5: Doenças Crônicas

```{r}
colunas_interesse <- c(
  "NOME    (iniciais)",
 "GRUPO      MN:0      MP:1", 
 "HIPERTENSÃO 0:não   1:sim",
 "DIABETES 0:não   1:sim",
 "HIPERCOLESTEROLEMIA 0:não   1:sim",
 "FIBROMIALGIA 0:não   1:sim",
 "GLAUCOMA 0:não   1:sim",
 "ENXAQUECA 0:não   1:sim",
 "HIPOTIREOIDISMO 0:não   1:sim",
 "ASMA 0:não   1:sim",
 "ESTEATOSE HEPÁTICA 0:não   1:sim",
 "SÍNDROME DO INTESTINO IRRITÁVEL 0:não   1:sim",
 "HEMANGIOMA  0:não   1:sim",
 "TROMBOFILIA  0:não   1:sim",
 "BRONQUITE  0:não   1:sim",
 "RINITE  0:não   1:sim",
 "OVÁRIOS POLICÍSTICOS 0:não   1:sim",
  "Transtorno de ansiedade generalizada (TAG)  0:não   1:sim",
 "SINUSITE 0:não 1:sim",
 "DEPRESSÃO 0:não   1:sim",
 "ARTROSE 0:não   1:sim",
 "LEUCOCITOSE 0:não   1:sim",
 "ANEMIA 0:não   1:sim",
 "SÍNDROME DO PÂNICO 0:não   1:sim",
 "GASTRITE 0:não   1:sim",
 "HEPATITE 0:não   1:sim",
 "CRISE ALÉRGICA 0:não   1:sim",
 "CISTITE 0:não   1:sim",
 "ANEMIA FALCIFORME 0: não 1:sim",
 "MIOMA UTERINO 0: não 1: sim",
 "CÁLCULO RENAL 0: não 1: sim",
 "CALCIFICAÇÃO MAMÁRIA 0: não 1: sim",
 "HIPOGLICEMIA 0: não 1: sim",
 "DERRAME DE VISTA 0: não 1: sim",
 "HIDRADENITE 0: não 1: sim",
 "GLOMERULOESCLEREOSE  0: não 1: sim",
 "PRÉ-DIABETES 0: não 1: sim",
  "BIPOLAR 0: não 1: sim",
  "TDAH 0: não 1: sim",
  "TEA 0: não 1: sim",
  "DOENÇA DE STILL 0: não 1: sim"
)

renomear_colunas <- c(
  "iniciais",
 "grupo", 
 "hipertensao",
 "diabetes",
 "hipercolesterolemia",
 "fibromialgia",
 "glaucoma",
 "enxaqueca",
 "hipotireoidismo",
 "asma",
 "esteatose_hepatica",
 "sindrome_intestino_irritavel",
 "hemangioma",
 "trombofilia",
 "bronquite",
 "rinite",
 "ovario_policistico",
 "TAG",
 "sinusite",
 "depressao",
 "artrose",
 "leucocitose",
 "anemia",
 "sindrome_panico",
 "gastrite",
 "hepatite",
 "crise_alergica",
 "cistite",
 "anemia_falciforme",
 "mioma_uterino",
 "calculo_renal",
 "calcificacao_mamaria",
 "hipoglicemia",
 "derrame de vista",
 "hidradenite",
 "glomeruloesclerose",
 "pre_diabetes",
 "bipolaridade",
 "TDAH",
 "TEA",
 "Doenca_Still"
)

df5 <- df5 %>% select(all_of(colunas_interesse))
colnames(df5) <- renomear_colunas

df5 <- df5 %>% 
  mutate_at(vars(-iniciais), as.numeric)
```

# Descritivas e Testes de Médias

```{r}
cor_verde = c("#4fb6a7")
cor_roxa = c("#652177")

cores = colorRampPalette(c("#4fb6a7","#652177"))
tema = theme_minimal() + 
       theme(axis.title.y = element_text(angle = 90, margin = unit(c(0.3, 0.5, 0.3, 0), "cm")),
             axis.title.x = element_text(margin = unit(c(0.3, 0, 0, 0), "cm")),
             axis.line.x = element_line(linewidth = 0.6, linetype=1),
             axis.line.y = element_line(linewidth = 0.6, linetype=1),
             axis.ticks.y = element_line(linewidth = 0.6, linetype = 1),
             axis.text = element_text(size=10),
             legend.position = "right",
             plot.margin = unit(c(0.3, 0.4, 0.3, 0.4), "cm"),
             plot.subtitle = element_text(hjust = 0.5, vjust= 4))
theme_set(tema)
```

## Funções que serão aplicadas:

* Funções de gráficos numéricos e categóricos

```{r}
graficos <- function(dados, grupo, variavel, texto = "variável"){
  
  dados <- dados %>% 
    mutate(grupo = ifelse(grupo == "0", "Grupo MN", "Grupo MP"))
  
  tab <- dados %>% 
    group_by(grupo) %>% 
    summarise(
      `Média` = mean( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Des. Padrão`= sd( !!sym(variavel) , na.rm = TRUE) %>% round(2),
      `Nulos` = is.na( !!sym(variavel) ) %>% sum() %>% round(2),
      `Quant.` = n() %>% round()) %>% 
    t()
  
  tabela <- data.frame(
    "Métrica" = row.names(tab)[2:5], 
    "MN" = as.numeric(tab[c(-1),1]),
    "MP" = as.numeric(tab[c(-1),2])) %>% 
    as_tibble()
  
  dados <- dados %>% filter(! is.na(variavel) )
  
  g1 <- dados %>%
    ggplot(aes(x = !!sym(grupo), y = !!sym(variavel), fill = !!sym(grupo))) + 
    geom_boxplot() + 
    labs(title = "Descritivas\n", x = "Grupos", y = str_to_upper(variavel), fill = "Grupos") +
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa))

  g2 <- dados %>% 
    ggplot(aes(x = !!sym(variavel))) +
    geom_histogram(fill = cor_verde) + 
    labs(y = "Frequência", x = str_to_upper(variavel))
  
  return(
    (g1 + gridExtra::tableGrob(tabela, rows = c("", "","", "")))/ 
      (g2)
  )
  }
```

* Função para gráficos categóricos

```{r}
graficos_categoricos <- function(lista1, lista2, variavel){
  
  tabela <- prop.table(
    table(lista1, lista2), 
    margin = 2) #freq da escolaridade dentro dos grupos, ex: freq do grupo 2 no grupo 1
  
  perc <- data.frame(tabela) %>% 
    mutate(lista1 = ifelse(lista1 == "0", "Grupo MN", "Grupo MP")) %>% 
    rename(`Frequência` = Freq)
  
  g1 <- perc %>% 
    ggplot(aes(x = lista2, y = `Frequência` , fill = lista1)) +
    geom_bar(stat='identity') + 
    tema +
    scale_fill_manual(values=c(cor_verde, cor_roxa)) +
    labs(
      x = str_to_title(variavel), 
      title = paste("Frequência de", variavel," por grupo"),
      fill = "Grupo") 
  
  return(g1)
}
```

* Teste de Hipóteses

```{r}
permutacoes <- function(grupo_MN, grupo_MP, n = 10000){
  difobs <- mean(grupo_MN, na.rm = T) - mean(grupo_MP, na.rm = T)
  dif <-numeric(n)
  todos <- c(grupo_MN, grupo_MP)
  todos <- todos[! is.na(todos)]
  set.seed(2023)
  N <- length(todos)

  for (i in 1:n) {
    # permutar dados
    sorteio <- sample(todos, replace = F)
  
    g1_perm <- sorteio[1:(N/2)]
    g2_perm <- sorteio[((N/2)+1):N]
    dif[i] <- mean(g1_perm)-mean(g2_perm)
  }
  valorp<- 2 * length(dif[dif > abs(difobs) ])/n # cauda superior
  alpha <- 0.05
  
  tipo_teste <- "Teste permutação"
  
  #cat(paste("Teste permutação\n",
  #          "Hipotese Alternativa: Medias diferentes para os grupos\n",
  #          paste0("Nivel de significancia de ", alpha),
  #          "pvalor =", valorp), 
  #    "\n", if_else(valorp >= alpha, "Não rejeita-se H0", "Rejeita-se H0"))
  
  return(list(method = tipo_teste, p.value = valorp))
  } 
```

```{r}
realizar_teste <- function(dataframe, variavel) {
  
  dataframefiltrado <- dataframe %>%
    mutate(grupo = ifelse(grupo == "0", "MN", "MP")) 

  grupo_MN<- dataframefiltrado %>%
    filter(grupo == "MN") %>%
    pull(variavel)
  
  grupo_MP<- dataframefiltrado %>%
    filter(grupo == "MP") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_MN)
  shapiro2 <- shapiro.test(grupo_MP)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_MN, grupo_MP)
  } else {
    resultado_teste <- t.test(grupo_MN, grupo_MP, alternative = "two.sided") 
    return(resultado_teste)
  }
}
```

* Teste de hipóteses para dados categóricos

```{r}
hipo_categorica <- function(dados, grupo, variavel){
  data_grupo <- dados %>% dplyr::select( !!sym(grupo) ) %>% pull( !!sym(grupo) )
  data_variavel <- dados %>% dplyr::select( !!sym(variavel) ) %>% pull( !!sym(variavel) )
  tab = xtabs(~ data_grupo + data_variavel) # tabela de frequencia
  return(fisher.test(tab))
}
```

* Função Resumo hipóteses

```{r}
resumo_testes <- function(teste, variavel){
    pvalor <- teste$p.value
    metodo <- teste$method  
    alpha <- 0.05
    conclusao <- if_else(pvalor >= alpha, "Não rejeita-se H0", "Rejeita-se H0")
    
    lista <- list(
      Nome = variavel,
      `Método` = metodo,
      Pvalor = pvalor %>% round(4),
      `Conclusão` = conclusao)
    
    return(lista %>% as_tibble() )
}
```

* Função para tratar dados extremos nos testes de hipóteses

```{r}
retira_extremos <- function(dados, coluna, ponto_corte){
  
  print_resumo <- function(res, momento){
    cat(
      paste("Resumo dos dados", momento, "da remoção:\n"),
      "Média:", mean(res, na.rm = T) %>% round(2),"\n",
      "Des. Padrão:", sd(res, na.rm = T) %>% round(2),"\n",
      "Nulos:", is.na(res) %>% sum(),"\n",
      "Total de observações:", res %>% length(),"\n\n")}
  
  cat("Foi encontrado observações extremas, elas serão retiradas.\n") 

  resumo <- dados %>% select(coluna) %>% pull(coluna)
  print_resumo(resumo, "antes")
  
  n_corte <- resumo[resumo > ponto_corte] %>% length()
  cat(paste(n_corte, "observações serão retirados entre nulos e extremos\n"))
  
  df_filtro <- dados %>% filter( !!sym(coluna) < ponto_corte)
  
  novo_resumo <- df_filtro %>% select(coluna) %>% pull(coluna)
  print_resumo(novo_resumo, "depois")
  
  return(df_filtro)
}
```

## Análise por variável:

### Idade:

```{r idade, fig.cap="Análise descritiva por grupo para a variável idade"}
variavel <- "idade"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado
resultado %>% kable(caption = "Resultado teste de hipótese")
```

A  indica...

### Etnia:

```{r, fig.cap="Análise descritiva por grupo para a variável etnia"}
variavel <- "etnia"
graficos_categoricos(df1$grupo, df1$etnia, variavel)
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- resultado
resultado %>% kable(caption = "Resultado teste de hipótese")

# Tabela de percentual
df_tab1 <- df1 %>% 
  mutate(grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab1 %>% 
  mutate(etnia = ifelse(etnia == 1, "Branca",
                         ifelse(etnia == 2, "Parda", "Negra")))
table(
  tab %>% pull(grupo), 
  tab %>% pull(etnia)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Escolaridade:

```{r, fig.cap="Análise descritiva por grupo para a variável escolaridade"}
variavel <- "escolaridade"
graficos_categoricos(df1$grupo, df1$escolaridade, variavel)
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(escolaridade = ifelse(escolaridade == 0, "4ª série",
                        ifelse(escolaridade == 1, "Fundamental",
                        ifelse(escolaridade == 2, "Ensino Médio", 
                        ifelse(escolaridade == 3, "Ensino técnico",
                        ifelse(escolaridade == 4, "Superior",
                                                  "Pós-graduação"))))))
  
table(
  tab %>% pull(grupo), 
  tab %>% pull(escolaridade)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Há quantos anos foi a gestação de interesse :

```{r, fig.cap="Análise descritiva por grupo para a variável num_gestacoes"}
variavel = "num_gestacoes"
graficos_categoricos(df1$grupo, df1$num_gestacoes, "Há quantos anos foi a gestação de interesse")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Peso da mulher:

```{r, fig.cap="Análise descritiva por grupo para a variável peso"}
variavel = "peso"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### IMC:

```{r, fig.cap="Análise descritiva por grupo para a variável IMC"}
variavel = "imc"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Percentual de gordura:

```{r, fig.cap="Análise descritiva por grupo para a variável gordura"}
variavel = "gordura"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão Sistólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão sistólica"}
variavel = "pressao_sis"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão Diastólica:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão diastólica"}
variavel = "pressao_dias"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Pressão arterial média:

```{r, fig.cap="Análise descritiva por grupo para a variável pressão média"}
variavel = "pressao_media"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de cintura:

```{r, fig.cap="Análise descritiva por grupo para a variável cintura"}
variavel = "cintura"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de abdômen:

```{r, fig.cap="Análise descritiva por grupo para a variável circunferência do abdômen"}
variavel = "abdomen"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Circunferência de quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável quadril"}
variavel = "quadril"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Relação cintura vs quadril:

```{r, fig.cap="Análise descritiva por grupo para a variável de relação da cintura vs quadril"}
variavel = "cintura_quadril"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Neutrófilos:

```{r, fig.cap="Análise descritiva por grupo para a variável neutrófilos"}
variavel = "neu"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Linfócitos:

```{r, fig.cap="Análise descritiva por grupo para a variável linfócitos"}
variavel = "lym"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Razão neutrófilo/linfócito NLR:

```{r, , fig.cap="Análise descritiva por grupo para a variável NLR"}
variavel = "nlr"

df_filtro <- retira_extremos(df1, variavel, 4)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Colesterol Total:

```{r, fig.cap="Análise descritiva por grupo para a variável colesterol total"}
variavel = "colesterol_total"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável HDL"}
variavel = "hdl"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### LDL dosado:

```{r, fig.cap="Análise descritiva por grupo para a variável LDL dosado"}
variavel = "ldl_dosado"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### VLDL:

```{r, fig.cap="Análise descritiva por grupo para a variável VLDL"}
variavel = "vldl"

df_filtro <- retira_extremos(df1, variavel, 45)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Não-HDL:

```{r, fig.cap="Análise descritiva por grupo para a variável Não-HDL"}
variavel = "nao_hdl"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Triglicérides:

```{r, fig.cap="Análise descritiva por grupo para a variável triglicérides"}
variavel = "triglicerides"
df_filtro <- retira_extremos(df1, variavel, 300)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Hemoglobina glicada HbA1c:

```{r, fig.cap="Análise descritiva por grupo para a variável HbA1c"}
variavel = "hba1c"

df_filtro <- retira_extremos(df1, variavel, 6)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Creatinina:

```{r, fig.cap="Análise descritiva por grupo para a variável creatinina"}
variavel = "hba1c"
df_filtro <- retira_extremos(df1, variavel, 4)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Ritmo de filtração glomerular:

```{r, fig.cap="Análise descritiva por grupo para a variável filtração glomerular"}
variavel = "filtr_glomerular"
df_filtro <- retira_extremos(df1, variavel, 400)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### TGP/ALT:

```{r, fig.cap="Análise descritiva por grupo para a variável TGP/ALT"}
variavel = "tgp_alt"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### TGO/AST:

```{r, fig.cap="Análise descritiva por grupo para a variável TGO/AST"}
variavel = "tgo_ast"
graficos(df1, "grupo", variavel)
teste <- realizar_teste(df1, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Ácido úrico:

```{r, fig.cap="Análise descritiva por grupo para a variável ácido úrico"}
variavel = "acido_urico"

df_filtro <- retira_extremos(df1, variavel, 8)
graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### CK:

Há apenas 2 observações no grupo MN de CK, logo, não é possível realizar o teste de médias.

```{r, fig.cap="Análise descritiva por grupo para a variável CK"}
variavel = "ck"
graficos(df1, "grupo", variavel)

df1 %>%
  mutate(Grupo = ifelse(grupo == "0", "MN", "MP")) %>%
  group_by(grupo) %>% 
  summarise(
    Nulos = sum(is.na(ck)),
    `Nao nulos` = sum(!is.na(ck))
    ) %>% kable(caption = "Quantidade de nulos e não nulos por grupo de CK")
```

### Gama GT:

```{r, fig.cap="Análise descritiva por grupo para a variável Gama GT"}
variavel = "gama_gt"

df_filtro <- retira_extremos(df1, variavel, 50)
graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Há quantos anos foi a gestação de interesse

```{r, fig.cap="Análise descritiva por grupo para a variável quantos anos passou-se do evento"}
variavel = "quantos_anos_evento"
graficos_categoricos(df2$grupo, 
                     df2$quantos_anos_evento, "quantos anos foi a gestação de interesse")

tab = xtabs(~ df2$grupo + df2$quantos_anos_evento) # tabela de frequencia
teste <- fisher.test(tab, simulate.p.value = T)
teste$method <- "Fisher's Exact Test for Count Data simulated"

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Peso do bebê:

```{r, fig.cap="Análise descritiva por grupo para a variável peso do bebê"}
variavel = "peso_bebe"
graficos(df2, "grupo", variavel) 
teste <- realizar_teste(df2, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Tipo Parto

```{r, fig.cap="Análise descritiva por grupo para a variável tipo de parto"}
df2_filtro <- df2 %>% 
  filter(tipo_parto != "<NA>")

variavel = "tipo_parto"
graficos_categoricos(df2_filtro$grupo, df2_filtro$tipo_parto, "Tipo de parto") 
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
df_tab2 <- df2 %>% 
  mutate(grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab2 %>% 
  mutate(tipo_parto = ifelse(tipo_parto == 0, "Normal",
                      ifelse(tipo_parto == 1, "Cesariana", 
                      ifelse(tipo_parto == 2, "Fórceps", "Induzido"))))
table(
  tab %>% pull(grupo), 
  tab %>% pull(tipo_parto)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Prematuro

```{r, fig.cap="Análise descritiva por grupo para a variável prematuro"}
df2_filtro <- df2 %>% 
  filter(prematuro != "<NA>")

variavel = "prematuro"
graficos_categoricos(df2_filtro$grupo, df2_filtro$prematuro, "prematuro") 
teste <- hipo_categorica(df2, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab2 %>% 
  mutate(prematuro = ifelse(prematuro == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(prematuro)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### PAI-1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável PAI-1"}
variavel = "pai1"
graficos(df3, "grupo", variavel) 
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Trombomodulina ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável trombomodulina"}
variavel = "trombomodulina"
graficos(df3, "grupo", variavel) 
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### ADMA ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável ADMA"}
variavel = "adma"
df_filtro <- retira_extremos(df3, variavel, 250)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### AA-AT1 ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável AA-AT1"}
variavel = "aaat1"
graficos(df3, "grupo", variavel)
teste <- realizar_teste(df3, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 sem previsões

```{r, fig.cap="Análise descritiva por grupo para a variável sflt1 sem previsões"}
variavel = "sflt1"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 com previsões feitas pelo ajuste da curva

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo ajuste da curva"}
df_est = results %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_geral = ifelse(is.na(sflt1), concentration.est, sflt1))
```

```{r}
variavel = "sflt1_geral"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Sflt1 com previsões feitas pelo método da Luiza

```{r, fig.cap="Análise descritiva por grupo para a variável Sflt1 com previsões feitas pelo método da Luiza"}
df_est = resultado_luiza %>% rename(absor_sflt1 = abs)
df = left_join(df3, df_est, relationship = "many-to-many")

df3 <- df %>% 
  mutate(sflt1_luiza = ifelse(is.na(sflt1), `Ajuste Luiza`, sflt1))
```

```{r}
variavel = "sflt1_luiza"

df_filtro <- retira_extremos(df3, variavel, 200)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Dímero-D ng/mL:

```{r, fig.cap="Análise descritiva por grupo para a variável dimero"}
variavel = "dimero"

df_filtro <- retira_extremos(df4, variavel, 1000)

graficos(df_filtro, "grupo", variavel)
teste <- realizar_teste(df_filtro, variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

### Hipertensão

```{r, fig.cap="Análise descritiva por grupo para a variável hipertensão"}
variavel = "hipertensao"
graficos_categoricos(df5$grupo, df5$hipertensao, "Hipertensão")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
df_tab5 <- df5 %>% 
  mutate(grupo = ifelse(grupo == 0, "Grupo MN", "Grupo MP"))

tab <- df_tab5 %>% 
  mutate(hipertensao = ifelse(hipertensao == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(hipertensao)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Anti-hipertensivo

```{r, fig.cap="Análise descritiva por grupo para a variável anti-hipertensivo"}
variavel = "anti_hiper"
graficos_categoricos(df1$grupo, df1$anti_hiper, "Anti-hipertensivo")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(anti_hiper = ifelse(anti_hiper == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(anti_hiper)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável diabetes"}
variavel = "diabetes"
graficos_categoricos(df5$grupo, df5$diabetes, "Diabetes")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(diabetes = ifelse(diabetes == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(diabetes)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Medicamento para diabetes

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para diabetes"}
variavel = "medic_diabetes"
graficos_categoricos(df1$grupo, df1$medic_diabetes, "Medicamento para diabetes")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_diabetes = ifelse(medic_diabetes == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(medic_diabetes)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável hipercolesterolemia"}
variavel = "hipercolesterolemia"
graficos_categoricos(df5$grupo, df5$hipercolesterolemia,"Hipercolesterolemia")
teste <- hipo_categorica(df5, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab5 %>% 
  mutate(hipercolesterolemia = ifelse(hipercolesterolemia == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(hipercolesterolemia)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Medicamento para hipercolesterolemia

```{r, fig.cap="Análise descritiva por grupo para a variável medicamento para hipercolesterolemia"}
variavel = "medic_hipercol"
graficos_categoricos(df1$grupo, df1$medic_hipercol, 
                     "Medicamento para hipercolesterolemia")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(medic_hipercol = ifelse(medic_hipercol == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(medic_hipercol)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

### Fumantes

```{r, fig.cap="Análise descritiva por grupo para a variável fumantes"}
variavel = "tabagista"
graficos_categoricos(df1$grupo, df1$tabagista, "Fumantes")
teste <- hipo_categorica(df1, "grupo", variavel)

resultado <- resumo_testes(teste, variavel)
tabela_resumo <- rbind(tabela_resumo, resultado)
resultado %>% kable(caption = "Resultado teste de hipótese")
```

```{r}
# Tabela de percentual
tab <- df_tab1 %>% 
  mutate(tabagista = ifelse(tabagista == 0, "Não","Sim"))

table(
  tab %>% pull(grupo), 
  tab %>% pull(tabagista)) %>% 
  prop.table(margin = 1) %>% round(4) * 100
```

## Resumo Descritivas

```{r}
tabela_resumo_ordenada <- tabela_resumo %>% arrange(Pvalor) 

tabela_resumo_ordenada %>% 
  kable(caption = "Resumo de todos os resultados dos testes")
```

Resumo Descritivas favoráveis para o estudo sobre as variáveis que impactam na média ou frequência dentro do grupo *Grupo MN* e *Grupo MP* para um nível de significância de $\alpha = 0,05$.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.05) %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 5% de significância")
```

Caso fosse assumido um nível de significância de $\alpha = 0,10$, as seguintes variáveis seriam candidatas a impactar no grupo.

```{r}
tabela_resumo_ordenada %>% 
  filter(Pvalor <= 0.1) %>% 
  mutate("Conclusão" = "Rejeita-se H0") %>% 
  kable(caption = "Resumo de todos os resultados favoráveis dos testes para 10% de significância")
```

# Modelo Linear Generalizado para hipertensão

```{r}
library(car)

## adicionando "2" nos nomes que são repetidos

posicoes_duplicadas <- which(duplicated(df1$iniciais))
df1$iniciais[posicoes_duplicadas] <- paste0(df1$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df3$iniciais))
df3$iniciais[posicoes_duplicadas] <- paste0(df3$iniciais[posicoes_duplicadas], "2")

posicoes_duplicadas <- which(duplicated(df4$iniciais))
df4$iniciais[posicoes_duplicadas] <- paste0(df4$iniciais[posicoes_duplicadas], "2")

## juntando data frames

dfreg <- df1 %>%
  left_join(df3, by = "iniciais") %>%
  left_join(df4, by = "iniciais")

dfreg %>% head()

## data frame só com as variáveis que eu vou precisar

dfreg<- cbind(dfreg$iniciais, dfreg$pressao_sis, dfreg$pressao_dias, dfreg$grupo.x, dfreg$idade, dfreg$tabagista, dfreg$imc, dfreg$gordura, dfreg$cintura, dfreg$quadril, dfreg$cintura_quadril, dfreg$colesterol_total, dfreg$hdl, dfreg$ldl_dosado, dfreg$triglicerides, dfreg$hba1c, dfreg$pai1, dfreg$aaat1, dfreg$dimero)

# nome pras colunas do df regressao

colnames(dfreg) <- c("iniciais", "pressao_sis", "pressao_dias", "grupo", "idade", "tabagista", "imc", "gordura", "cintura", "quadril", "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides", "hba1c", "pai1", "aaat1", "dimero")

## colocando em ordem crescente a quantidade de na presentes em cada coluna

sort(colMeans(is.na(dfreg)))
```


```{r}
# novo df que será usado para a regressão

dfmodelo <- dfreg[, c("iniciais","pressao_sis", "pressao_dias","grupo", "idade", "tabagista", "imc", "gordura", "cintura", "quadril","cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides")] %>% na.omit %>% as_tibble()


var_cat <- c("iniciais", "grupo")

dfmodelo <- dfmodelo %>% mutate_at(vars(-var_cat), as.numeric)

dfmodelo$alta_pressao <- ifelse(dfmodelo$pressao_sis > 140 | dfmodelo$pressao_dias > 90, "1", "0")

realizar_teste2 <- function(dataframe, variavel) {

  grupo_1<- dataframe %>%
    filter(alta_pressao == "0") %>%
    pull(variavel)
  
  grupo_2<- dataframe %>%
    filter(alta_pressao == "1") %>%
    pull(variavel)

  shapiro1 <- shapiro.test(grupo_1)
  shapiro2 <- shapiro.test(grupo_2)

  if (shapiro1$p.value <= 0.05 || shapiro2$p.value <= 0.05) {
    permutacoes(grupo_1, grupo_2)
  } else {
    resultado_teste <- t.test(grupo_1, grupo_2, alternative = "two.sided") 
    return(resultado_teste)
  }
}

col_teste_num <- c("pressao_sis", "pressao_dias","idade", "imc", "gordura", "cintura", "quadril",
               "cintura_quadril", "colesterol_total", "hdl", "ldl_dosado", "triglicerides")

tabela_resumo <-  resumo_testes( realizar_teste2(dfmodelo, "pressao_sis"),"pressao_sis")

for (col in col_teste_num[-1]) {
    teste_hiper <- realizar_teste2(dfmodelo, col)
    resultado <- resumo_testes(teste_hiper, col)
    tabela_resumo <- rbind(tabela_resumo, resultado)
}

tabela_resumo %>% arrange(Pvalor)
```


# Referências

https://dl.acm.org/doi/pdf/10.1145/503506.503509

https://est.ufba.br/sites/est.ufba.br/files/kim/matd49-aula04-fisher.pdf

https://www.jstor.org/stable/2527460?seq=1

http://ndl.ethernet.edu.et/bitstream/123456789/15304/1/9103.pdf